BACKUP ~klatu/backup~
AUTHOR ~klatu~
VERSION ~1.7~
README ~klatu/readme-klatu.html~

AUTO_TRA ~klatu/lang/%s~
LANGUAGE ~English~
         ~English~
         ~klatu/lang/english/setup.tra~
LANGUAGE ~German~
         ~German~
         ~klatu/lang/german/setup.tra~

/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////
/////                                                       /////
///// Content Changes                                       /////
/////                                                       /////
/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// The Gloves of Goodman Hayes                           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @0 DESIGNATED 1000
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ohnrobe1.itm~ @3 //Required file missing
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~Ar0334.bcs~ @3 //Required file missing
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~WSMITH01.dlg~ @3 //Required file missing
		COPY ~klatu/itm/kla#glvh.itm~ ~override~
			SAY NAME1 @5 // Gloves
			SAY NAME2 @6 // Gloves of Goodman Hayes
			SAY DESC @7
		EXTEND_BOTTOM ~Ar0334.bcs~ ~klatu/baf/glovesHayesAr0334.baf~
		COMPILE ~klatu/d/glovesHayesCromwell.d~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// The Manual of War                                     /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @147 DESIGNATED 1010
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2 //Incompatible Game
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ITEMDIAL.2da~ @3 //Required file missing
		REQUIRE_PREDICATE ((FILE_EXISTS_IN_GAME ~thalan.dlg~) OR
							(FILE_EXISTS_IN_GAME ~doghma.dlg~) OR
							(FILE_EXISTS_IN_GAME ~25spell.dlg~)) @3 //Required file missing
		
		// add possibly missing TOB actions
		ACTION_IF (NOT GAME_IS ~bgee bg2ee eet iwdee~) BEGIN
			APPEND ~action.ids~ ~160 ApplySpellRES(S:RES*,O:Target)~ UNLESS ~ApplySpellRES(S:RES\*,O:Target)~
		END
		
		ACTION_DEFINE_ARRAY idxToChar BEGIN
			~0~ ~1~ ~2~ ~3~ ~4~ ~5~
			~6~ ~7~ ~8~ ~9~ ~a~ ~b~
			~c~ ~d~ ~e~ ~f~ ~g~ ~h~
			~i~ ~j~ ~k~ ~l~ ~m~ ~n~
		END
		OUTER_SET i = 0
		
		ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ BEGIN
			// opcode 321 crashes non-EE versions
			// PROFICIENCYCLUB is EXTRAPROFICIENCY1 in non-EE versions
			ACTION_FOR_EACH p IN
				~PROFICIENCYBASTARDSWORD~
				~PROFICIENCYLONGSWORD~
				~PROFICIENCYSHORTSWORD~
				~PROFICIENCYAXE~
				~PROFICIENCYTWOHANDEDSWORD~
				~PROFICIENCYKATANA~
				~PROFICIENCYSCIMITARWAKISASHININJATO~
				~PROFICIENCYDAGGER~
				~PROFICIENCYWARHAMMER~
				~PROFICIENCYCLUB~
				~PROFICIENCYSPEAR~
				~PROFICIENCYHALBERD~
				~PROFICIENCYFLAILMORNINGSTAR~
				~PROFICIENCYMACE~
				~PROFICIENCYQUARTERSTAFF~
				~PROFICIENCYCROSSBOW~
				~PROFICIENCYLONGBOW~
				~PROFICIENCYSHORTBOW~
				~PROFICIENCYDART~
				~PROFICIENCYSLING~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ ~3~ ~4~ ~5~ BEGIN
					COPY ~klatu/spl/gainProfEE.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_ASCIIE 0x0ae ~kla#bk%a%1~ #8
						WRITE_ASCIIE 0x0de ~kla#bk%a%2~ #8
						WRITE_ASCIIE 0x10e ~kla#bk%a%3~ #8
						WRITE_ASCIIE 0x13e ~kla#bk%a%4~ #8
						WRITE_ASCIIE 0x16e ~kla#bk%a%5~ #8
						WRITE_LONG 0x18e ~%b%~
						WRITE_LONG 0x192 ~%d%~
					//
				END
				OUTER_SET i = i + 1
			END
			
			ACTION_FOR_EACH p IN
				~PROFICIENCY2HANDED~
				~PROFICIENCYSWORDANDSHIELD~
				~PROFICIENCYSINGLEWEAPON~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ BEGIN
					COPY ~klatu/spl/gainProfEE.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_ASCIIE 0x0ae ~kla#bk%a%1~ #8
						WRITE_ASCIIE 0x0de ~kla#bk%a%2~ #8
						WRITE_LONG 0x18e ~%b%~
						WRITE_LONG 0x192 ~%d%~
						DELETE_BYTES 0x0fa 144
						READ_SHORT 0x90 num
						WRITE_SHORT 0x90 (num - 3)
					//
				END
				OUTER_SET i = i + 1
			END
			
			ACTION_FOR_EACH p IN
				~PROFICIENCY2WEAPON~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ ~3~BEGIN
					COPY ~klatu/spl/gainProfEE.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_ASCIIE 0x0ae ~kla#bk%a%1~ #8
						WRITE_ASCIIE 0x0de ~kla#bk%a%2~ #8
						WRITE_ASCIIE 0x10e ~kla#bk%a%3~ #8
						WRITE_LONG 0x18e ~%b%~
						WRITE_LONG 0x192 ~%d%~
						DELETE_BYTES 0x12a 96
						READ_SHORT 0x90 num
						WRITE_SHORT 0x90 (num - 2)
					//
				END
				OUTER_SET i = i + 1
			END
			
		END ELSE BEGIN
			ACTION_FOR_EACH p IN
				~PROFICIENCYBASTARDSWORD~
				~PROFICIENCYLONGSWORD~
				~PROFICIENCYSHORTSWORD~
				~PROFICIENCYAXE~
				~PROFICIENCYTWOHANDEDSWORD~
				~PROFICIENCYKATANA~
				~PROFICIENCYSCIMITARWAKISASHININJATO~
				~PROFICIENCYDAGGER~
				~PROFICIENCYWARHAMMER~
				~EXTRAPROFICIENCY1~
				~PROFICIENCYSPEAR~
				~PROFICIENCYHALBERD~
				~PROFICIENCYFLAILMORNINGSTAR~
				~PROFICIENCYMACE~
				~PROFICIENCYQUARTERSTAFF~
				~PROFICIENCYCROSSBOW~
				~PROFICIENCYLONGBOW~
				~PROFICIENCYSHORTBOW~
				~PROFICIENCYDART~
				~PROFICIENCYSLING~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ ~3~ ~4~ ~5~ BEGIN
					COPY ~klatu/spl/gainProf.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_LONG 0x9e ~%b%~
						WRITE_LONG 0xa2 ~%d%~
					//
				END
				OUTER_SET i = i + 1
			END
			
			ACTION_FOR_EACH p IN
				~PROFICIENCY2HANDED~
				~PROFICIENCYSWORDANDSHIELD~
				~PROFICIENCYSINGLEWEAPON~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ BEGIN
					COPY ~klatu/spl/gainProf.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_LONG 0x9e ~%b%~
						WRITE_LONG 0xa2 ~%d%~
					//
				END
				OUTER_SET i = i + 1
			END
			
			ACTION_FOR_EACH p IN
				~PROFICIENCY2WEAPON~
			BEGIN
				OUTER_SET d = IDS_OF_SYMBOL (stats ~%p%~)
				OUTER_SPRINT a $idxToChar(~%i%~)
				ACTION_FOR_EACH b IN ~1~ ~2~ ~3~ BEGIN
					COPY ~klatu/spl/gainProf.spl~ ~override/kla#bk%a%%b%.spl~
						WRITE_LONG 0x9e ~%b%~
						WRITE_LONG 0xa2 ~%d%~
					//
				END
				OUTER_SET i = i + 1
			END
		END
		
		COPY ~klatu/spl/permanentBonusTHAC0.spl~ ~override/kla#bko0.spl~
			SAY 0xce @220
		COPY ~klatu/spl/permanentBonusDamage.spl~ ~override/kla#bko1.spl~
			SAY 0xce @219
		COPY ~klatu/spl/permanentBonusAC.spl~ ~override/kla#bko2.spl~
			SAY 0xce @218
		COPY ~klatu/spl/permanentBonusCastingSpeed.spl~ ~override/kla#bkoh.spl~
			SAY 0xce @217
		COPY ~klatu/spl/permanentBonusStrength.spl~ ~override/kla#bko5.spl~
			SAY 0xce @212
		COPY ~klatu/spl/permanentBonusDexterity.spl~ ~override/kla#bko6.spl~
			SAY 0xce @213
		COPY ~klatu/spl/permanentBonusConstitution.spl~ ~override/kla#bko7.spl~
			SAY 0xce @214
		COPY ~klatu/spl/permanentBonusIntelligence.spl~ ~override/kla#bko8.spl~
			SAY 0xce @215
		COPY ~klatu/spl/permanentBonusWisdom.spl~ ~override/kla#bko9.spl~
			SAY 0xce @216
		
		COPY ~klatu/spl/permanentUAI.spl~ ~override/kla#bkoi.spl~
			SAY 0xce @209
		COPY ~klatu/spl/permanentBonusCharisma.spl~ ~override/kla#bkoa.spl~
			SAY 0xce @208
		COPY ~klatu/spl/permanentExtraHalfAttack.spl~ ~override/kla#bko3.spl~
			SAY 0xce @207
		COPY ~klatu/spl/permanentBonusCritChance.spl~ ~override/kla#bko4.spl~
			SAY 0xce @206
		COPY ~klatu/spl/gainTime.spl~ ~override/kla#bkoe.spl~
			SAY 0x15e @162
			SAY 0x18e @162
			SAY 0x1be @162
			SAY 0x1ee @162
			SAY 0x21e @162
			SAY 0x24e @162
			SAY 0x27e @162
			SAY 0x2ae @162
			SAY 0x2de @162
			SAY 0x30e @162
			SAY 0x33e @162
			SAY 0x36e @162
			SAY 0x39e @162
			SAY 0x3ce @162
			SAY 0x3fe @162
			SAY 0x42e @162
		COPY ~klatu/spl/permanentAuraCleansing.SPL~ ~override/kla#bkog.spl~
			SAY 0xce @203
		COPY ~klatu/spl/permanentImmunityPetrification.SPL~ ~override/kla#bkok.spl~
			SAY 0xce @170
			SAY 0xfe @204
		COPY ~klatu/spl/permanentRegeneration.spl~ ~override/kla#bkoc.spl~
			SAY 0xce @221
		COPY ~klatu/spl/permanentImmunityPoisonAndDisease.spl~ ~override/kla#bkol.spl~
			SAY 0x1be @166
			SAY 0x1ee @167
			SAY 0x21e @168
			SAY 0x24e @169
			SAY 0x27e @222
		COPY ~klatu/spl/gainBlind.spl~ ~override/kla#bkof.spl~
			SAY 0x18e @162
			SAY 0x1be @162
			SAY 0x1ee @162
			SAY 0x21e @162
			SAY 0x24e @163
			SAY 0x27e @164
			SAY 0x2ae @165
			SAY 0x33e @162
		COPY ~klatu/spl/permanentMindBlank.SPL~ ~override/kla#bkob.spl~
			SAY 0x09e @148
			SAY 0x0ce @149
			SAY 0x0fe @150
			SAY 0x12e @151
			SAY 0x15e @152
			SAY 0x18e @153
			SAY 0x1be @154
			SAY 0x1ee @155
			SAY 0x21e @156
			SAY 0x24e @157
			SAY 0x6fe @162
			SAY 0x72e @162
			SAY 0x81e @194
			SAY 0x84e @195
			SAY 0x87e @202
		COPY ~klatu/spl/permanentFreeAction.spl~ ~override/kla#bkod.spl~
			SAY 0x09e @152
			SAY 0x0ce @153
			SAY 0x0fe @158
			SAY 0x12e @159
			SAY 0x15e @162
			SAY 0x18e @162
			SAY 0x1be @162
			SAY 0x1ee @162
			SAY 0x21e @162
			SAY 0x24e @162
			SAY 0x27e @162
			SAY 0x2ae @162
			SAY 0x2de @162
			SAY 0x30e @162
			SAY 0x33e @162
			SAY 0x36e @162
			SAY 0x6ce @220
		COPY ~klatu/spl/gainPerf.spl~ ~override/kla#bkoj.spl~
			SAY 0x09e @171
			SAY 0x0ce @172
		
		ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ BEGIN
			COMPILE ~klatu/d/warEE.d~
			COPY ~klatu/bam/kla#bk01.bam~ ~override~
		END ELSE BEGIN
			COMPILE ~klatu/d/war.d~
			COPY ~klatu/bam/kla#bk01SMALL.bam~ ~override/kla#bk01.bam~
		END
		
		COPY_EXISTING ~ITEMDIAL.2da~ ~override~
			APPEND_FILE ~klatu/d/ITEMDIAL.txt~
			REPLACE ~kla#strref~ ~Read~
		COPY ~klatu/itm/kla#bk01.itm~ ~override~
			SAY 0x08 @160
			SAY 0x0c @160
			SAY 0x50 @161
			SAY 0x54 @161
			// not supported yet
			PATCH_IF (GAME_IS ~iwdee~) BEGIN
				WRITE_ASCII 0x58 ~~ #8	// disable desc image
			END
		
		// thalantyr
		ACTION_IF (FILE_EXISTS_IN_GAME ~thalan.dlg~) BEGIN
			ACTION_IF (GAME_IS ~bgt~) BEGIN
				COMPILE ~klatu/d/bookThalanBGT.d~
			END ELSE BEGIN
				COMPILE ~klatu/d/bookThalan.d~
			END
		END
		// priest of oghma (bg2)
		ACTION_IF (FILE_EXISTS_IN_GAME ~doghma.dlg~) BEGIN
			COMPILE ~klatu/d/bookDoghma.d~
		END
		// lazarus
		ACTION_IF (FILE_EXISTS_IN_GAME ~25spell.dlg~) BEGIN
			COMPILE ~klatu/d/bookLazarus.d~
		END
		
		// ulcaster
		ACTION_IF (FILE_EXISTS_IN_GAME ~AR3901.bcs~) BEGIN
			EXTEND_TOP ~AR3901.bcs~ ~klatu/baf/ulcasterSpawn.baf~
		END
		ACTION_IF (FILE_EXISTS_IN_GAME ~AR9798.bcs~) BEGIN
			EXTEND_TOP ~AR9798.bcs~ ~klatu/baf/ulcasterSpawn.baf~
		END
		
		// BGT transition
		ACTION_IF (FILE_EXISTS_IN_GAME ~aram00.bcs~) BEGIN
			EXTEND_TOP ~aram00.bcs~ ~klatu/baf/transitionBGT.baf~
		END
		
		// post transition or import
		ACTION_IF (FILE_EXISTS_IN_GAME ~ar0602.bcs~) BEGIN
			EXTEND_TOP ~ar0602.bcs~ ~klatu/baf/bg2import.baf~
		END
		
		// wk spawn
		ACTION_IF (FILE_EXISTS_IN_GAME ~ar3016.bcs~) BEGIN
			EXTEND_TOP ~ar3016.bcs~ ~klatu/baf/wkspawn.baf~
		END
		// TODO kaylessa/orrik for IWD

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Prepared Wishes                                       /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		
		BEGIN @8 DESIGNATED 1020
		GROUP @1
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~wish25.dlg~ @3
		
		INCLUDE ~klatu/lib/common.tpa~
		
		// add possibly missing TOB actions
		ACTION_IF (NOT GAME_IS ~bgee bg2ee eet iwdee~) BEGIN
			APPEND ~action.ids~ ~348 SetupWish(I:Column*,I:Count*)~ UNLESS ~SetupWish(I:Column\*,I:Count\*)~
		END
		
		COPY ~klatu/spl/randomWish.spl~ ~override/kla#wprn.spl~
			SAY NAME1 @9
		COPY ~klatu/eff/castWish.eff~ ~override/kla#wprn.eff~
			WRITE_ASCII 0x30 ~kla#wprn~
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp08.spl~
			SAY NAME1 @10
			SAY UNIDENTIFIED_DESC @11
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp10.spl~
			SAY NAME1 @12
			SAY UNIDENTIFIED_DESC @13
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp11.spl~
			SAY NAME1 @14
			SAY UNIDENTIFIED_DESC @15
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp12.spl~
			SAY NAME1 @16
			SAY UNIDENTIFIED_DESC @17
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp13.spl~
			SAY NAME1 @18
			SAY UNIDENTIFIED_DESC @19
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp14.spl~
			SAY NAME1 @20
			SAY UNIDENTIFIED_DESC @21
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp16.spl~
			SAY NAME1 @22
			SAY UNIDENTIFIED_DESC @23
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp17.spl~
			SAY NAME1 @24
			SAY UNIDENTIFIED_DESC @25
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp27.spl~
			SAY NAME1 @26
			SAY UNIDENTIFIED_DESC @27
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp28.spl~
			SAY NAME1 @28
			SAY UNIDENTIFIED_DESC @29
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp30.spl~
			SAY NAME1 @30
			SAY UNIDENTIFIED_DESC @31
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp31.spl~
			SAY NAME1 @32
			SAY UNIDENTIFIED_DESC @33
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp32.spl~
			SAY NAME1 @34
			SAY UNIDENTIFIED_DESC @35
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp35.spl~
			SAY NAME1 @36
			SAY UNIDENTIFIED_DESC @37
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp37.spl~
			SAY NAME1 @38
			SAY UNIDENTIFIED_DESC @39
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp38.spl~
			SAY NAME1 @40
			SAY UNIDENTIFIED_DESC @41
		COPY ~klatu/spl/prepWish.spl~ ~override/kla#wp46.spl~
			SAY NAME1 @42
			SAY UNIDENTIFIED_DESC @43
		ACTION_FOR_EACH num IN ~08~ ~10~ ~11~ ~12~ ~13~ ~14~ ~16~ ~17~ ~27~ ~28~ ~30~ ~31~ ~32~ ~35~ ~37~ ~38~ ~46~ BEGIN
			COPY ~klatu/eff/castWish.eff~ ~override/kla#wp%num%.eff~
				WRITE_ASCIIE 0x30 ~spwish%num%~
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				READ_LONG 0x64 abilOff
				READ_SHORT 0x68 abilNum
				READ_LONG 0x6a fxOff
				FOR (a = 0; a < (abilNum - 1); a = a + 1) BEGIN
					off = abilOff + a * 0x28
					READ_SHORT (off + 0x1e) fxNum
					READ_SHORT (off + 0x20) fxIdx
					WRITE_ASCII (fxOff + (fxIdx + 0) * 0x30 + 0x14) ~kla#wprn~
					WRITE_ASCIIE (fxOff + (fxIdx + 1) * 0x30 + 0x14) ~kla#wp%num%~
				END
				off = abilOff + (abilNum - 1) * 0x28
				READ_SHORT (off + 0x1e) fxNum
				READ_SHORT (off + 0x20) fxIdx
				WRITE_ASCIIE (fxOff + (fxIdx + 0) * 0x30 + 0x14) ~kla#wp%num%~
			//
		END
		ACTION_FOR_EACH num IN ~27~ ~30~ ~31~ ~35~ BEGIN
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				LPF SET_CASTING_SPEED_ALL INT_VAR value = 6 END
		END
		ACTION_FOR_EACH num IN ~11~ ~12~ ~13~ ~14~ BEGIN
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				LPF SET_CASTING_SPEED_ALL INT_VAR value = 7 END
		END
		ACTION_FOR_EACH num IN ~08~ ~38~ BEGIN
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				LPF SET_CASTING_SPEED_ALL INT_VAR value = 8 END
		END
		ACTION_FOR_EACH num IN ~37~ ~10~ ~28~ ~46~  BEGIN
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				LPF SET_CASTING_SPEED_ALL INT_VAR value = 9 END
		END
		ACTION_FOR_EACH num IN ~16~ ~17~ ~32~ BEGIN
			COPY_EXISTING ~kla#wp%num%.spl~ ~override~
				LPF SET_CASTING_SPEED_ALL INT_VAR value = 12 END
		END
		COMPILE ~klatu/d/preparedWishes.d~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Romance Cheat: Isra will Romance Neutral Characters   /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @131 DESIGNATED 1030
		GROUP @1
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~ISRA_BG2/ISRA_BG2.TP2~ ~0~ @198
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~rh#isr.bcs~ @3
		
		EXTEND_TOP ~rh#isr.bcs~ ~klatu/baf/isra_allow_neutral.baf~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Give Hexxat an Inactive Fighter Class                 /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @133 DESIGNATED 1040
		GROUP @1
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ohhex8.cre~ @3
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ohhex25.cre~ @3
		INCLUDE ~klatu/lib/common.tpa~
		ACTION_FOR_EACH cre IN ~ohhex8.cre~ ~ohhex25.cre~ BEGIN
			COPY_EXISTING ~%cre%~ ~override~
				LPF SANITIZE_CRE RET ok = ok END
				PATCH_IF ok BEGIN
					READ_BYTE 0x010 f1	// flags 1st byte
					READ_BYTE 0x011 f2	// flags 2nd byte
					READ_BYTE 0x273 cl	// class
					t1 = (f1 BAND 0b11111000)	// mask byte 1
					t2 = (f2 BAND 0b00000001)	// mask byte 2
					PATCH_IF ((NOT (cl = 4)) OR (NOT (t1 = 0)) OR (NOT (t2 = 0))) BEGIN
						INNER_ACTION BEGIN
							FAIL @134
						END
					END ELSE BEGIN
						WRITE_BYTE 0x010 (f1 BOR 0b00001000)	// set inactive fighter class
						WRITE_SHORT 0x024 102	// current HP
						WRITE_SHORT 0x026 102	// max HP
						WRITE_BYTE 0x273 0x09	// set class to FIGHTER_THIEF
						WRITE_BYTE 0x234 13		// set level 1st class
						WRITE_BYTE 0x235 8		// set level 2nd class
						WRITE_BYTE 0x236 0		// set level 3rd class
						LPF ADD_DEFAULT_EFFECT_CRE INT_VAR opcode = 233 param1 = 0x18 param2 = 0x72 END	// inactive proficiency
						LPF ADD_DEFAULT_EFFECT_CRE INT_VAR opcode = 233 param1 = 0x28 param2 = 0x5e END	// inactive proficiency
					END
				END ELSE BEGIN
					INNER_ACTION BEGIN
						FAIL @135
					END
				END
			BUT_ONLY
		END
		// patches were applied to base file without failing
		// copy base file and adjust xp. 
		COPY_EXISTING ~ohhex8.cre~ ~override/ohhex9.cre~
			WRITE_LONG 0x18 161000
		BUT_ONLY
		COPY_EXISTING ~ohhex8.cre~ ~override/ohhex10.cre~
			WRITE_LONG 0x18 200000
		BUT_ONLY
		COPY_EXISTING ~ohhex8.cre~ ~override/ohhex11.cre~
			WRITE_LONG 0x18 400000
		BUT_ONLY
		COPY_EXISTING ~ohhex8.cre~ ~override/ohhex13.cre~
			WRITE_LONG 0x18 800000
		BUT_ONLY
		COPY_EXISTING ~ohhex8.cre~ ~override/ohhex15.cre~
			WRITE_LONG 0x18 1200000
		BUT_ONLY
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Appropriate XP Rewards for Cowled Enforcers           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @136 DESIGNATED 1050
		GROUP @1
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		// only install if any cowled wizard can be encountered.
		REQUIRE_PREDICATE (
			(FILE_EXISTS_IN_GAME ~cowenf02.cre~) OR
			(FILE_EXISTS_IN_GAME ~cowenf2.cre~) OR
			(FILE_EXISTS_IN_GAME ~cucow1.cre~) OR
			(FILE_EXISTS_IN_GAME ~cucow2.cre~) OR
			(FILE_EXISTS_IN_GAME ~cucow3.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz1.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz2.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz3.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz4.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz5.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwiz6.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwizc.cre~) OR
			(FILE_EXISTS_IN_GAME ~cuwizsu.cre~) OR
			(FILE_EXISTS_IN_GAME ~L-MAGE01.cre~) OR
			(FILE_EXISTS_IN_GAME ~L-MAGE02.cre~) OR
			(FILE_EXISTS_IN_GAME ~O#CRENF1.cre~) OR
			(FILE_EXISTS_IN_GAME ~O#CRENF2.cre~) OR
			(FILE_EXISTS_IN_GAME ~mage18z.cre~)
		) @3 // required file missing
		INCLUDE ~klatu/lib/common.tpa~
		
		ACTION_FOR_EACH cre IN ~cowenf02.cre~ ~cowenf2.cre~ ~cucow1.cre~ ~cucow2.cre~ ~cucow3.cre~ 
			~cuwiz1.cre~ ~cuwiz2.cre~ ~cuwiz3.cre~ ~cuwiz4.cre~ ~cuwiz5.cre~ ~cuwiz6.cre~ ~cuwizc.cre~
			~cuwizsu.cre~ ~L-MAGE01.cre~ ~L-MAGE02.cre~ ~O#CRENF1.cre~ ~O#CRENF2.cre~
		BEGIN
			ACTION_IF FILE_EXISTS_IN_GAME ~%cre%~ BEGIN
				COPY_EXISTING ~%cre%~ ~override~
					LPF SANITIZE_CRE RET ok = ok END
					PATCH_IF ok BEGIN
						WRITE_LONG 0x14 6000
					END
				BUT_ONLY
			END
		END
		ACTION_IF FILE_EXISTS_IN_GAME ~mage18z.cre~ BEGIN
			COPY_EXISTING ~mage18z.cre~ ~override~
				LPF SANITIZE_CRE RET ok = ok END
				PATCH_IF ok BEGIN
					WRITE_LONG 0x14 24000
				END
			BUT_ONLY
		END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Skip Candlekeep Chores and CtB intro cutscenes        /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @196 DESIGNATED 1060
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~SETUP-CTB-CHORES.TP2~ ~0~ @198 // Required mod component missing
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ar0602.bcs~ @3 //Required file missing
		
		COPY_EXISTING ~ar0602.bcs~ ~override~
			DECOMPILE_AND_PATCH BEGIN
				REPLACE_TEXTUALLY CASE_INSENSITIVE EXACT_MATCH ~StartCutScene("CBNEWGMM")~ ~SetGlobal("KD_ChoresDone","GLOBAL",1)StartCutScene("NEWGAME")~
				REPLACE_TEXTUALLY CASE_INSENSITIVE EXACT_MATCH ~StartCutScene("CBNEWGMF")~ ~SetGlobal("KD_ChoresDone","GLOBAL",1)StartCutScene("NEWGAME")~
			END
		BUT_ONLY
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// CtB: Remove Venereal Disease                          /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @200 DESIGNATED 1070
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~CTB/SETUP-CTB.TP2~ ~0~ @198 // Required mod component missing
		
		// stop checking for disease
		COPY_EXISTING ~baldur.bcs~ ~override~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis1.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis2.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis3.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis4.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis5.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis6.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis7.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis8.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis9.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis10.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis11.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis12.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis13.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis14.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis15.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis16.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis17.baf~ ~klatu/baf/blank.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_dis18.baf~ ~klatu/baf/blank.baf~
		BUT_ONLY
		// stop giving disease
		ACTION_FOR_EACH num IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ BEGIN
			ACTION_FOR_EACH file IN ~CBCWP%num%DA~ ~CBCWP%num%DB~ ~CBCWP%num%DC~ ~CBCWP%num%DD~ BEGIN
				COPY_EXISTING ~%file%.bcs~ ~override~
					DECOMPILE_AND_PATCH BEGIN
						REPLACE_TEXTUALLY CASE_INSENSITIVE EXACT_MATCH ~IncrementGlobal("CbPlayer%num%DiseasedByCowl","GLOBAL",1)~ ~~
						REPLACE_TEXTUALLY CASE_INSENSITIVE EXACT_MATCH ~SetGlobalTimer("CbPlayer%num%DiseasedDay","GLOBAL",7200)~ ~~
					END
				BUT_ONLY
			END
		END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// CtB: Fixed Harp of Myth Drannor                       /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @201 DESIGNATED 1080
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~CTB/SETUP-CTB.TP2~ ~0~ @198 // Required mod component missing
		INCLUDE ~klatu/lib/common.tpa~
		
		// make sure only one instance of the harp is dropped with correct charges
		COPY_EXISTING ~CB3548DP.bcs~ ~override~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_harpDrop1.baf~ ~klatu/baf/ctb_harpDrop1_fix.baf~
			REPLACE_BCS_BLOCK ~klatu/baf/ctb_harpDrop2.baf~ ~klatu/baf/ctb_harpDrop2_fix.baf~
		BUT_ONLY
		
		// fix the harp item
		COPY_EXISTING ~CBWTNI1a.ITM~ ~override~
			// remove all abilities and effects whole-sale
			DELETE_BYTES	0x72 (SOURCE_SIZE - 0x72)	// delete effect data
			WRITE_LONG		0x64 0x72					// ab offset
			WRITE_SHORT 	0x68 0						// ab num
			WRITE_LONG		0x6a 0x72					// fx offset
			WRITE_SHORT		0x6e 0						// fx index
			WRITE_SHORT		0x70 0						// fx num
			// add one ability
			LPF ADD_ABILITY_ITM RET off = off END
			WRITE_BYTE		 off 		3				// magical
			WRITE_BYTE		(off +  1)	1				// identify to use
			WRITE_BYTE		(off +  2)	3				// item slots
			WRITE_ASCIIE	(off +  4)	~ICBWTNI1~ #8	// icon
			WRITE_BYTE		(off + 12)	1				// living actor
			WRITE_SHORT		(off + 14)	25				// range
			WRITE_BYTE		(off + 22)	6				// dice size
			WRITE_SHORT		(off + 28)	1				// piercing
			WRITE_SHORT		(off + 34)	7				// charges
			WRITE_SHORT		(off + 36)	1				// item vanishes
			WRITE_LONG		(off + 38)	0x00000100		// (8) unknown
			WRITE_SHORT		(off + 42)	79				// projectile
			WRITE_SHORT		(off + 44)	34				// anim % 1
			WRITE_SHORT		(off + 46)	33				// anim % 2
			WRITE_SHORT		(off + 48)	33				// anim % 3
			
			// add effects
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 10	// prob. high
						prob2	= 0		// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1A~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 21	// prob. high
						prob2	= 11	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1B~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 32	// prob. high
						prob2	= 22	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1C~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 43	// prob. high
						prob2	= 33	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1D~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 54	// prob. high
						prob2	= 44	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1E~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 65	// prob. high
						prob2	= 55	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1F~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 77	// prob. high
						prob2	= 66	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1G~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 89	// prob. high
						prob2	= 78	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1H~
			END
			
			LPF ADD_ABILITY_EFFECT_ITM RET off = off END
			LPF WRITE_EFFECT
				INT_VAR	off		= off
						opcode	= 146	// cast spell
						target	= 2		// preset target
						param1	= 1		// cast at level 1
						param2	= 1		// cast instantly
						timing	= 1		// instant
						prob1	= 100	// prob. high
						prob2	= 90	// prob. low
				STR_VAR
						res = EVAL ~CBWTNI1I~
			END
		BUT_ONLY
		
		// copy fixed harp instance for sake of completeness
		COPY_EXISTING ~CBWTNI1a.ITM~ ~override/CBWTNI1b.ITM~
		COPY_EXISTING ~CBWTNI1a.ITM~ ~override/CBWTNI1c.ITM~
		COPY_EXISTING ~CBWTNI1a.ITM~ ~override/CBWTNI1d.ITM~
		
		// fix spells
		COPY ~klatu/spl/permanentAuraCleansing.SPL~ ~override/CBWTNI1A.spl~
			SAY 0xce @203
		
		COPY ~klatu/spl/permanentMindBlank.SPL~ ~override/CBWTNI1B.spl~
			SAY 0x09e @148
			SAY 0x0ce @149
			SAY 0x0fe @150
			SAY 0x12e @151
			SAY 0x15e @152
			SAY 0x18e @153
			SAY 0x1be @154
			SAY 0x1ee @155
			SAY 0x21e @156
			SAY 0x24e @157
			SAY 0x6fe @162
			SAY 0x72e @162
			SAY 0x81e @194
			SAY 0x84e @195
			SAY 0x87e @202
		
		COPY ~klatu/spl/permanentBerserk.SPL~ ~override/CBWTNI1C.spl~
			SAY 0xce @205
		
		COPY ~klatu/spl/permanentBonusCritChance.spl~ ~override/CBWTNI1D.spl~
			SAY 0xce @206
		
		COPY ~klatu/spl/permanentExtraHalfAttack.spl~ ~override/CBWTNI1E.spl~
			SAY 0xce @207
		
		COPY ~klatu/spl/permanentBonusCharisma.spl~ ~override/CBWTNI1F.spl~
			SAY 0xce @208
		
		COPY ~klatu/spl/permanentUAI.spl~ ~override/CBWTNI1G.spl~
			SAY 0xce @209
			
		COPY ~klatu/spl/permanentAlignmentNeutral.spl~ ~override/CBWTNI1H.spl~
			SAY 0xce @210
		
		COPY ~klatu/spl/permanentDeafness.spl~ ~override/CBWTNI1I.spl~
			SAY 0xce @211
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// RoT: Remove cutscenes from Chateau Irenicus           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @197 DESIGNATED 1090
		GROUP @1 // Content Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~SETUP-ROT.TP2~ ~0~ @198 // Required mod component missing
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~ar0602.bcs~ @3 //Required file missing
		
		COPY_EXISTING ~ar0602.bcs~ ~override~
			REPLACE_BCS_BLOCK ~klatu/baf/rot_cut1.baf~ ~klatu/baf/blank.baf~
		BUT_ONLY
		ACTION_IF FILE_EXISTS_IN_GAME ~ar0603.bcs~ BEGIN
			COPY_EXISTING ~ar0603.bcs~ ~override~
				REPLACE_BCS_BLOCK ~klatu/baf/rot_cut2.baf~ ~klatu/baf/blank.baf~
			BUT_ONLY
		END
		ACTION_IF FILE_EXISTS_IN_GAME ~tele0700.bcs~ BEGIN
			COPY_EXISTING ~tele0700.bcs~ ~override~
				REPLACE_BCS_BLOCK ~klatu/baf/rot_cut3.baf~ ~klatu/baf/blank.baf~
			BUT_ONLY
		END
	
/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////
/////                                                       /////
///// Gameplay Tweaks and Fixes                             /////
/////                                                       /////
/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Streamlined Wizard Spell Progression                  /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @145 DESIGNATED 2000
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~mxsplwiz.2da~ @3 //Required file missing
		
		COPY ~klatu/2da/mxsplwiz.2da~ ~override~
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Streamlined Sorcerer Spell Progression                /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @146 DESIGNATED 2010
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~mxsplsrc.2da~ @3 //Required file missing
		
		COPY ~klatu/2da/mxsplsrc.2da~ ~override~
			 ~klatu/2da/splsrckn.2da~ ~override~
			 ~klatu/2da/mxspldd.2da~ ~override~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// No Item Deprecation                                   /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @44 DESIGNATED 2020
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		
		COPY_EXISTING_REGEXP GLOB ~^.+\.sto$~ ~override~
			PATCH_IF (SOURCE_SIZE >= 0x9c) BEGIN
				WRITE_LONG 0x1c 0x00
			END
		BUT_ONLY
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Identify All Store Items                              /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @189 DESIGNATED 2030
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		COPY_EXISTING_REGEXP GLOB ~^.+\.sto$~ ~override~
			PATCH_IF (SOURCE_SIZE >= 0x9c) BEGIN
				READ_LONG 0x34 itmOff
				READ_LONG 0x38 itmNum
				// 28 bytes per sold item
				PATCH_IF (SOURCE_SIZE >= (itmOff + itmNum * 0x1c)) BEGIN
					// all items exist within file bounds
					FOR (itmIdx = 0; itmIdx < itmNum; itmIdx = itmIdx + 1) BEGIN
						off = itmOff + itmIdx * 0x1c + 16	// offset to item flags
						READ_BYTE off b						// read first 8 flag bits
						WRITE_BYTE off (b BOR 0b00000001)	// set identified bit
					END
				END
			END
		BUT_ONLY
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Fix Wild Mage Items and Spells                        /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @46 DESIGNATED 2040
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/wildMageFix.tpa~
		
		ACTION_FOR_EACH res IN ~a7helm1~ ~hoody1~ ~o!bom057~ ~s#clck01~ ~u#helm02~ ~u#helm03~ ~wzrdring~ ~ohnrobe1~ ~ohnhelm1~ BEGIN
			LAF WM_IMPLEMENT_FIX INT_VAR abilLen = 0x38 STR_VAR res = EVAL ~%res%.itm~ END
		END
		ACTION_FOR_EACH res IN ~spwi222~ ~spwi723~ BEGIN
			LAF WM_IMPLEMENT_FIX INT_VAR abilLen = 0x28 STR_VAR res = EVAL ~%res%.spl~ END
		END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Prevent Wish Spells from Interrupting Caster          /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @47 DESIGNATED 2050
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE ((FILE_EXISTS_IN_GAME ~wish.dlg~) OR (FILE_EXISTS_IN_GAME ~wish25.dlg~)) @3
		INCLUDE ~klatu/lib/common.tpa~
		
		// add possibly missing TOB actions
		ACTION_IF (NOT GAME_IS ~bgee bg2ee eet~) BEGIN
			APPEND ~action.ids~ ~113 ForceSpellRES(S:RES*,O:Target)~ UNLESS ~ForceSpellRES(S:RES\*,O:Target)~
		END
		
		ACTION_FOR_EACH spl IN ~spwi406~ ~spwi909~ ~spwi916~ ~spin735~ ~spwish13~ ~spwish17~ ~spwish20~ ~spwish22~ BEGIN
			ACTION_IF (FILE_EXISTS_IN_GAME ~%spl%.spl~) BEGIN
				COPY_EXISTING ~%spl%.spl~ ~override~
					LPF SANITIZE_SPL RET ok = ok END
					PATCH_IF ok BEGIN
						READ_LONG 0x64 abilOff
						READ_SHORT 0x68 abilNum
						READ_LONG 0x6a fxOff
						FOR (a = 0; a < abilNum; a = a + 1) BEGIN
							off = abilOff + a * 0x28
							READ_SHORT (off + 0x1e) fxNum
							READ_SHORT (off + 0x20) fxIdx
							FOR (i = fxNum - 1; i >= 0; --i) BEGIN
								WRITE_BYTE (fxOff + (fxIdx + i) * 0x30 + 0x02) 2	// change effect target
							END
						END
						READ_SHORT 0x70 fxNum
						FOR (i = fxNum - 1; i >= 0; --i) BEGIN
							WRITE_BYTE (fxOff + i * 0x30 + 0x02) 2	// // change effect target
						END
					END
				BUT_ONLY
			END
		END
		COPY	~klatu/eff/wish2~ ~override~
		ACTION_FOR_EACH num IN ~08~ ~10~ ~11~ ~12~ ~13~ ~14~ ~16~ ~17~ ~18~ ~19~ ~20~ 
			~21~ ~22~ ~23~ ~24~ ~25~ ~26~ ~28~ ~29~ ~30~ ~31~ ~32~ ~33~ ~34~ ~35~ ~36~ 
			~37~ ~38~ ~39~ ~40~ ~41~ ~42~ ~43~ ~44~ ~45~ ~46~
		BEGIN
			COPY ~klatu/spl/wish2/kla#wi%num%.spl~ ~override/kla#wi%num%.spl~
				WRITE_ASCIIE 0xae ~kla#wi%num%~ #8
			//
		END
		ACTION_IF FILE_EXISTS_IN_GAME ~wish.dlg~ BEGIN
			COMPILE	~klatu/d/wishNoInterrupt.d~
		END
		ACTION_IF FILE_EXISTS_IN_GAME ~wish25.dlg~ BEGIN
			COMPILE	~klatu/d/wish2NoInterrupt.d~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Standardize Poison Immunity                           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @101 DESIGNATED 2060
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/poisonImmunity.tpa~
		
		LAF PI_IMPLEMENT_STANDARDIZE_POISON_IMMUNITY END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Free Action does not Prevent Haste or Movement Rate Bonus /
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @142 DESIGNATED 2070
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/freeAction.tpa~
		
		LAF FA_IMPLEMENT_FREE_ACTION
			STR_VAR logFile = ~klatu/log/freeAction.txt~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Drop Equipment on Disintegration                      /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @48 DESIGNATED 2080
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/dropEquipment.tpa~
		
		COPY ~klatu/spl/drop.spl~ ~override/kla#deqd.spl~
		COPY ~klatu/eff/drop.eff~ ~override/kla#deqd.eff~
			WRITE_ASCIIE 0x30 ~kla#deqd~ #8
		LAF DQ_IMPLEMENT_DROP_EQUIPMENT
			INT_VAR	opcode = 238 requiredDelay = 0
			STR_VAR logFile = ~klatu/log/drop.txt~ dropRes = ~kla#deqd~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Drop Equipment on Petrification                       /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @50 DESIGNATED 2090
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/dropEquipment.tpa~
		
		COPY ~klatu/spl/drop.spl~ ~override/kla#deqp.spl~
		COPY ~klatu/eff/drop.eff~ ~override/kla#deqp.eff~
			WRITE_ASCIIE 0x30 ~kla#deqp~ #8
		LAF DQ_IMPLEMENT_DROP_EQUIPMENT
			INT_VAR	opcode = 134 requiredDelay = 0
			STR_VAR logFile = ~klatu/log/drop.txt~ dropRes = ~kla#deqp~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Drop Equipment on Imprisonment                        /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @51 DESIGNATED 2100
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/dropEquipment.tpa~
		
		COPY ~klatu/spl/drop.spl~ ~override/kla#deqi.spl~
		COPY ~klatu/eff/drop.eff~ ~override/kla#deqi.eff~
			WRITE_ASCIIE 0x30 ~kla#deqi~ #8
		LAF DQ_IMPLEMENT_DROP_EQUIPMENT
			INT_VAR	opcode = 211 requiredDelay = 1
			STR_VAR logFile = ~klatu/log/drop.txt~ dropRes = ~kla#deqi~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Treat all Innate Abilities as Non-Magical             /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @105 DESIGNATED 2110
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/unaffectWildMagic.tpa~
		
		LAF UW_IMPLEMENT_UNAFFECT_SPELLS INT_VAR spellType = 4 boolSilence = 1 END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Treat all Psionic Abilities as Non-Magical            /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @106 DESIGNATED 2120
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/unaffectWildMagic.tpa~
		
		LAF UW_IMPLEMENT_UNAFFECT_SPELLS INT_VAR spellType = 3 boolSilence = 1 END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Treat all Bardsong Effects as Non-Magical             /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @107 DESIGNATED 2130
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/unaffectWildMagic.tpa~
		
		LAF UW_IMPLEMENT_UNAFFECT_SPELLS INT_VAR spellType = 5 boolSilence = 0 END

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Allow Arcane Spellcasting in Armor                    /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @138 DESIGNATED 2140
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		
		COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				READ_SHORT 0x1c itmType
				PATCH_IF (itmType = 2) BEGIN
					READ_LONG 0x6a fxOff
					READ_SHORT 0x70 fxNum
					FOR (i = fxNum - 1; i >= 0; i = i - 1) BEGIN
						off = fxOff + i * 0x30
						READ_SHORT off opcode
						READ_LONG (off + 0x08) param2
						PATCH_IF ((((opcode = 60) OR (opcode = 145)) AND (param2 = 0))
							OR ((opcode = 144) AND (param2 > 1) AND (param2 < 6))) BEGIN
							LPF REMOVE_EFFECT_ITM INT_VAR idx = i END
						END
					END
				END
			END
		BUT_ONLY
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Allow Thievery in Armor                               /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @139 DESIGNATED 2150
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		
		COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				READ_SHORT 0x1c itmType
				PATCH_IF (itmType = 2) BEGIN
					READ_LONG 0x6a fxOff
					READ_SHORT 0x70 fxNum
					FOR (i = fxNum - 1; i >= 0; i = i - 1) BEGIN
						off = fxOff + i * 0x30
						READ_SHORT off opcode
						READ_LONG (off + 0x08) param2
						PATCH_IF ((opcode = 144) AND ((param2 = 0) OR (param2 = 1))) BEGIN
							LPF REMOVE_EFFECT_ITM INT_VAR idx = i END
						END
					END
				END
			END
		BUT_ONLY
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Remove Delay from Improved Haste Spells               /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @141 DESIGNATED 2160
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		INCLUDE ~klatu/lib/improvedHasteDelay.tpa~
		
		LAF HD_IMPLEMENT_REMOVE_IMPROVED_HASTE_DELAY END

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Reputation has no Effect on Store Prices              /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @143 DESIGNATED 2170
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~REPMODST.2da~ @3
		
		COPY ~klatu/2da/REPMODST.2da~ ~override~
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Charisma has a stronger Effect on Store Prices        /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @144 DESIGNATED 2180
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~CHRMODST.2da~ @3
		
		COPY ~klatu/2da/CHRMODST.2da~ ~override~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Modal Buff AI Script                                  /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @187 DESIGNATED 2190
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/scripts.tpa~
		
		// add possibly missing TOB actions
		ACTION_IF (NOT GAME_IS ~bgee bg2ee eet iwdee~) BEGIN
			APPEND ~action.ids~ ~147 RemoveSpellRES(S:Spell*)~ UNLESS ~RemoveSpellRES(S:Spell\*)~
			APPEND ~action.ids~ ~181 ReallyForceSpellRES(S:RES*,O:Target)~ UNLESS ~ReallyForceSpellRES(S:RES\*,O:Target)~
		END
		
		// set cross document vars
		OUTER_SPRINT var_mode ~"kla#AImode"~
		OUTER_SPRINT var_buff ~"kla#AIbuff"~
		OUTER_SPRINT var_hide ~"kla#AIhide"~
		OUTER_SPRINT hotkey_self ~C~
		OUTER_SPRINT hotkey_other ~V~
		OUTER_SPRINT hotkey_party ~B~
		OUTER_SPRINT hotkey_toggle ~S~
		OUTER_SPRINT hotkey_cycle ~D~
		OUTER_SET var_range = 6
		
		// comile base script with vars
		COMPILE EVALUATE_BUFFER ~klatu/baf/kla#buff.baf~ 
		
		// compile buff others routine
		OUTER_FOR (i = 1; i < 7; ++i) BEGIN
			OUTER_SPRINT var_player ~Player%i%~
			
			OUTER_SET var_pass1 = (200 + (%i% - 1) * 10)
			OUTER_SET var_pass2 = (201 + (%i% - 1) * 10)
			OUTER_SET var_pass3 = (202 + (%i% - 1) * 10)
			
			// 3rd pass
			OUTER_SET var_buff_val = %var_pass3%
			
			LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_THE_ELEMENTS~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_THE_ELEMENTS~ res = ~SPWI702~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%OR(3)
				!CheckStatGT(%var_player%,99,RESISTFIRE)
				!CheckStatGT(%var_player%,99,RESISTCOLD)
				!CheckStatGT(%var_player%,99,RESISTELECTRICITY)%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_FREE_ACTION~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_FREE_ACTION~ res = ~SPPR403~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STATE_NOT STR_VAR nam = ~STATE_NONDETECTION~ RET state = con END
			LAF SPELL STR_VAR nam = ~WIZARD_NON_DETECTION~ res = ~SPWI310~ RET spl = con act = act END
			OUTER_SPRINT con ~%state%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE2~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_DEATH_WARD~ res = ~SPPR409~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_CHAOTIC_COMMANDS~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_CHAOTIC_COMMANDS~ res = ~SPPR508~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE3~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_NEGATIVE_PLANE_PROTECTION~ res = ~SPPR413~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
			LAF STAT_NOT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat2 = con END
			LAF SPELL STR_VAR nam = ~WIZARD_STRENGTH~ res = ~SPWI214~ RET spl = con act = act END
			OUTER_SPRINT con ~!CheckStatGT(%var_player%,17,STR)%stat%%stat2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
			LAF STAT_NOT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat2 = con END
			LAF SPELL STR_VAR nam = ~WIZARD_STRENGTH~ res = ~SPWI214~ RET spl = con act = act END
			OUTER_SPRINT con ~CheckStat(%var_player%,18,STR)!CheckStatGT(%var_player%,49,STREXTRA)%stat%%stat2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STATE_NOT STR_VAR nam = ~STATE_AID~ RET state = con END
			LAF SPELL STR_VAR nam = ~CLERIC_AID~ res = ~SPPR201~ RET spl = con act = act END
			OUTER_SPRINT con ~%state%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_REGENERATION~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_REGENERATE~ res = ~SPPR711~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			// 3rd pass done
			// go to next player
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/next%i%.baf~ EVALUATE_BUFFER
			
			// 2nd pass
			OUTER_SET var_buff_val = %var_pass2%
			
			LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ res = ~SPWI803~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%OR(5)
								!CheckStatGT(%var_player%,99,RESISTFIRE)
								!CheckStatGT(%var_player%,99,RESISTCOLD)
								!CheckStatGT(%var_player%,99,RESISTELECTRICITY)
								!CheckStatGT(%var_player%,99,RESISTACID)
								!CheckStatGT(%var_player%,99,MAGICDAMAGERESISTANCE)%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			// 2nd pass done
			// go to 3rd pass
			
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/goto3.baf~ EVALUATE_BUFFER
			
			// 1st pass
			
			OUTER_SET var_buff_val = %var_pass1%
			
			LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_FREE_ACTION~ RET stat = con END
			LAF STAT_NOT_GT STR_VAR nam = ~IMPROVEDHASTE~ RET stat2 = con END
			LAF SPELL STR_VAR nam = ~WIZARD_IMPROVED_HASTE~ res = ~SPWI613~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%stat2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_BARKSKIN~ res = ~SPPR202~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_NORMAL_MISSILES~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_NORMAL_MISSILES~ res = ~SPWI311~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_PETRIFICATION~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_PETRIFICATION~ res = ~SPWI108~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
			LAF SPELL_NOT STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl3 = con END
			LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_EVIL~ res = ~SPWI113~ RET spl2 = con END
			LAF SPELL STR_VAR nam = ~PALADIN_PROTECTION_FROM_EVIL~ res = ~SPCL213~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl3%%spl2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
			LAF SPELL_NOT STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl2 = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_EVIL~ res = ~SPWI113~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 39 STR_VAR nam = ~RESISTMAGIC~ RET stat = con END
			LAF SPELL STR_VAR nam = ~CLERIC_MAGIC_RESISTANCE~ res = ~SPPR509~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTFIRE~ RET stat = con END
			LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_FIRE~ res = ~SPWI319~ RET spl2 = con END
			LAF SPELL STR_VAR nam = ~CLERIC_PROTECTION_FROM_FIRE~ res = ~SPPR306~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl2%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTFIRE~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_FIRE~ res = ~SPWI319~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTCOLD~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_COLD~ res = ~SPWI320~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTELECTRICITY~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ELECTRICITY~ res = ~SPWI512~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTACID~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ACID~ res = ~SPWI517~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~MAGICDAMAGERESISTANCE~ RET stat = con END
			LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_MAGIC_ENERGY~ res = ~SPWI606~ RET spl = con act = act END
			OUTER_SPRINT con ~%stat%%spl%~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			// 1st pass done
			// go to 3rd
			LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ res = ~SPWI803~ RET con = con END
			OUTER_SPRINT act ~SetGlobal(%var_buff%,"LOCALS",%var_pass3%)~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
			
			// or go to 2nd pass
			OUTER_SPRINT con ~~
			OUTER_SPRINT act ~SetGlobal(%var_buff%,"LOCALS",%var_pass2%)~
			EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		END
		
		// buff self
		OUTER_SPRINT var_player ~Myself~
		OUTER_SET var_pass1 = 100
		OUTER_SET var_pass2 = 110
		OUTER_SET var_pass3 = 120
		
		// 3rd pass
		OUTER_SET var_buff_val = %var_pass3%
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_THE_ELEMENTS~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_THE_ELEMENTS~ res = ~SPWI702~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%OR(3)
	!CheckStatGT(%var_player%,99,RESISTFIRE)
	!CheckStatGT(%var_player%,99,RESISTCOLD)
	!CheckStatGT(%var_player%,99,RESISTELECTRICITY)%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_FREE_ACTION~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_FREE_ACTION~ res = ~SPPR403~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STATE_NOT STR_VAR nam = ~STATE_NONDETECTION~ RET state = con END
		LAF SPELL STR_VAR nam = ~WIZARD_NON_DETECTION~ res = ~SPWI310~ RET spl = con act = act END
		OUTER_SPRINT con ~%state%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE2~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_DEATH_WARD~ res = ~SPPR409~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_CHAOTIC_COMMANDS~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_CHAOTIC_COMMANDS~ res = ~SPPR508~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE3~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_NEGATIVE_PLANE_PROTECTION~ res = ~SPPR413~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL_NOT STR_VAR nam = ~SHAPECHANGE_MIND_FLAYER~ res = ~SPIN152~ RET spl4 = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_POLYMORPH_FLIND~ res = ~SPWI493~ RET spl3 = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_SHAPECHANGE~ res = ~SPWI916~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_POLYMORPH_SELF~ res = ~SPWI416~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl4%%spl3%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL_NOT STR_VAR nam = ~SHAPECHANGE_MIND_FLAYER~ res = ~SPIN152~ RET spl3 = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_POLYMORPH_FLIND~ res = ~SPWI493~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SHAPECHANGE~ res = ~SPWI916~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl3%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF STAT_NOT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_STRENGTH~ res = ~SPWI214~ RET spl = con act = act END
		OUTER_SPRINT con ~!CheckStatGT(%var_player%,17,STR)%stat%%stat2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF STAT_NOT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_STRENGTH~ res = ~SPWI214~ RET spl = con act = act END
		OUTER_SPRINT con ~CheckStat(%var_player%,18,STR)!CheckStatGT(%var_player%,49,STREXTRA)%stat%%stat2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_HOLY_POWER~ res = ~SPPR412~ RET spl = con act = act END
		OUTER_SPRINT con ~!CheckStatGT(%var_player%,17,STR)%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_HOLY_POWER~ res = ~SPPR412~ RET spl = con act = act END
		OUTER_SPRINT con ~CheckStat(%var_player%,18,STR)!CheckStatGT(%var_player%,99,STREXTRA)%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_DRAW_UPON_HOLY_MIGHT~ res = ~SPPR214~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~INNATE_DRAW_UPON_HOLY_MIGHT~ res = ~SPIN103~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_DRAW_UPON_HOLY_MIGHT~ res = ~SPPR214~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 5 STR_VAR nam = ~SCRIPTINGSTATE6~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_RIGHTEOUS_MAGIC~ res = ~SPPR513~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STATE_NOT STR_VAR nam = ~STATE_AID~ RET state = con END
		LAF SPELL STR_VAR nam = ~CLERIC_AID~ res = ~SPPR201~ RET spl = con act = act END
		OUTER_SPRINT con ~%state%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 0 STR_VAR nam = ~CLERIC_BLADE_BARRIER~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_GLOBE_OF_BLADES~ res = ~SPPR725~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~CLERIC_BLADE_BARRIER~ res = ~SPPR603~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 1 STR_VAR nam = ~CLERIC_BLADE_BARRIER~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_GLOBE_OF_BLADES~ res = ~SPPR725~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_PHYSICAL_MIRROR~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_PHYSICAL_MIRROR~ res = ~SPPR613~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_REGENERATION~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_REGENERATE~ res = ~SPPR711~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~TRUE_SIGHT~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_TRUE_SIGHT~ res = ~SPWI609~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~CLERIC_TRUE_SIGHT~ res = ~SPPR505~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~TRUE_SIGHT~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_TRUE_SIGHT~ res = ~SPWI609~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_SHIELD~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SPELL_SHIELD~ res = ~SPWI519~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_DEFLECTION~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_SPELL_DEFLECTION~ res = ~SPWI618~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_MINOR_SPELL_DEFLECTION~ res = ~SPWI318~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_DEFLECTION~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SPELL_DEFLECTION~ res = ~SPWI618~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_TURNING~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_SPELL_TURNING~ res = ~SPWI701~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_MINOR_SPELL_TURNING~ res = ~SPWI522~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_TURNING~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SPELL_TURNING~ res = ~SPWI701~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~MINORGLOBE~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_GLOBE_OF_INVULNERABILITY~ res = ~SPWI602~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_MINOR_GLOBE_OF_INVULNERABILITY~ res = ~SPWI406~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~MINORGLOBE~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_GLOBE_OF_INVULNERABILITY~ res = ~SPWI602~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_SPELL_TRAP~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SPELL_TRAP~ res = ~SPWI902~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		// 3rd pass done
		// terminate
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/next6.baf~ EVALUATE_BUFFER
		
		// 2nd pass
		OUTER_SET var_buff_val = %var_pass2%
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ res = ~SPWI803~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%OR(5)
	!CheckStatGT(%var_player%,99,RESISTFIRE)
	!CheckStatGT(%var_player%,99,RESISTCOLD)
	!CheckStatGT(%var_player%,99,RESISTELECTRICITY)
	!CheckStatGT(%var_player%,99,RESISTACID)
	!CheckStatGT(%var_player%,99,MAGICDAMAGERESISTANCE)%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		// 2nd pass done
		// go to 3rd pass
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/goto3.baf~ EVALUATE_BUFFER
		
		// 1st pass
		OUTER_SET var_buff_val = %var_pass1%
		
		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_FREE_ACTION~ RET stat = con END
		LAF STAT_NOT_GT STR_VAR nam = ~IMPROVEDHASTE~ RET stat2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_IMPROVED_HASTE~ res = ~SPWI613~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%stat2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~STONESKINS~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_IRONSKIN~ res = ~SPPR506~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_STONE_SKIN~ res = ~SPWI408~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~STONESKINS~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_IRONSKIN~ res = ~SPPR506~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_BARKSKIN~ res = ~SPPR202~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 1 STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SHIELD~ res = ~SPWI114~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT INT_VAR val = 2 STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_SPIRIT_ARMOR~ res = ~SPWI414~ RET spl3 = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_GHOST_ARMOR~ res = ~SPWI317~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_ARMOR~ res = ~SPWI102~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl3%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 3 STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_SPIRIT_ARMOR~ res = ~SPWI414~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_GHOST_ARMOR~ res = ~SPWI317~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 4 STR_VAR nam = ~SCRIPTINGSTATE5~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_SPIRIT_ARMOR~ res = ~SPWI414~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STATE_NOT STR_VAR nam = ~STATE_BLUR~ RET state = con END
		LAF SPELL STR_VAR nam = ~WIZARD_BLUR~ res = ~SPWI201~ RET spl = con act = act END
		OUTER_SPRINT con ~%state%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STATE_NOT STR_VAR nam = ~STATE_MIRRORIMAGE~ RET state = con END
		LAF SPELL STR_VAR nam = ~WIZARD_MIRROR_IMAGE~ res = ~SPWI212~ RET spl = con act = act END
		OUTER_SPRINT con ~%state%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_NORMAL_MISSILES~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_NORMAL_MISSILES~ res = ~SPWI311~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_PROTECTION_FROM_PETRIFICATION~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_PETRIFICATION~ res = ~SPWI108~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl3 = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_EVIL~ res = ~SPWI113~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~PALADIN_PROTECTION_FROM_EVIL~ res = ~SPCL213~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl3%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_EVIL~ res = ~SPWI113~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~PROTECTION_FROM_EVIL~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_PROTECT_FROM_EVIL~ res = ~SPPR107~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF STAT_NOT_GT STR_VAR nam = ~CLERIC_ARMOR_OF_FAITH~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_ARMOR_OF_FAITH~ res = ~SPPR111~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_FIRE_SHIELD~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_ARMOR_OF_FAITH~ res = ~SPPR730~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT STR_VAR nam = ~WIZARD_FIRE_SHIELD~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_FIRE_SHIELD_RED~ res = ~SPWI418~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 1 STR_VAR nam = ~WIZARD_FIRE_SHIELD~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_FIRE_SHIELD_BLUE~ res = ~SPWI403~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 39 STR_VAR nam = ~RESISTMAGIC~ RET stat = con END
		LAF SPELL STR_VAR nam = ~CLERIC_MAGIC_RESISTANCE~ res = ~SPPR509~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTFIRE~ RET stat = con END
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_FIRE~ res = ~SPWI319~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~CLERIC_PROTECTION_FROM_FIRE~ res = ~SPPR306~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTFIRE~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_FIRE~ res = ~SPWI319~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTCOLD~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_COLD~ res = ~SPWI320~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTELECTRICITY~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ELECTRICITY~ res = ~SPWI512~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~RESISTACID~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_ACID~ res = ~SPWI517~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF STAT_NOT_GT INT_VAR val = 99 STR_VAR nam = ~MAGICDAMAGERESISTANCE~ RET stat = con END
		LAF SPELL STR_VAR nam = ~WIZARD_PROTECTION_FROM_MAGIC_ENERGY~ res = ~SPWI606~ RET spl = con act = act END
		OUTER_SPRINT con ~%stat%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		// 1st pass done
		// go to 3rd
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_PROTECTION_FROM_ENERGY~ res = ~SPWI803~ RET spl2 = con END
		//LAF SPELL_NOT STR_VAR nam = ~TALOS_STORMSHIELD~ res = ~SPCL721~ RET spl = con END
		//OUTER_SPRINT con ~%spl2%%spl%~
		OUTER_SPRINT con ~%spl2%~
		OUTER_SPRINT act ~SetGlobal(%var_buff%,"LOCALS",%var_pass3%)~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		// or go to 2nd pass
		OUTER_SPRINT con ~~
		OUTER_SPRINT act ~SetGlobal(%var_buff%,"LOCALS",%var_pass2%)~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		// party buff
		OUTER_SET var_buff_val = 300

		LAF SPELL STR_VAR nam = ~CLERIC_PROTECTION_FROM_EVIL_10_FOOT~ res = ~SPPR408~ RET con = con act = act END
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_RESIST_FEAR~ res = ~SPWI210~ RET spl3 = con END
		LAF SPELL_NOT STR_VAR nam = ~CLERIC_REMOVE_FEAR~ res = ~SPPR108~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~CAVALIER_REMOVE_FEAR~ res = ~SPCL222~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl3%%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		LAF SPELL_NOT STR_VAR nam = ~WIZARD_RESIST_FEAR~ res = ~SPWI210~ RET spl2 = con END
		LAF SPELL STR_VAR nam = ~CLERIC_REMOVE_FEAR~ res = ~SPPR108~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl2%%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~WIZARD_RESIST_FEAR~ res = ~SPWI210~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~WIZARD_HASTE~ res = ~SPWI305~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~CLERIC_STRENGTH_OF_ONE~ res = ~SPPR312~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~CLERIC_CHANT~ res = ~SPPR203~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~CLERIC_DEFENSIVE_HARMONY~ res = ~SPPR406~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER

		LAF SPELL STR_VAR nam = ~CLERIC_BLESS~ res = ~SPPR101~ RET spl = con act = act END
		OUTER_SPRINT con ~%spl%~
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/block.baf~ EVALUATE_BUFFER
		
		// party buffs done
		// terminate
		EXTEND_BOTTOM ~kla#buff.bcs~ ~klatu/baf/next6.baf~ EVALUATE_BUFFER
		
		// AI routine done
		MOVE ~override/kla#buff.bcs~ ~scripts/kla#buff.bs~
		
		// brute-force the script entry into the 2DA
		COPY_EXISTING ~SCRPDESC.2DA~ ~override~
			off = SOURCE_SIZE
			INSERT_BYTES off (24)			// insert some bytes for writing a strrefs
			SAY (off) ~MODAL BUFF:~			// write new strref (4 bytes)
			SAY (off + 12) @188				// write new strref (4 bytes)
			READ_LONG (off) refA			// read the value of the new strref
			READ_LONG (off + 12) refB		// read the value of the new strref
			DELETE_BYTES off (24)			// delete all the written bytes again
			COUNT_2DA_ROWS 3 rows
			INSERT_2DA_ROW rows 3 ~kla#buff    %refA%        %refB%~	// insert the new strrefs properly
		//
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Familiars can sort magical scrolls                    /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @190 DESIGNATED 2200
		GROUP @45
		REQUIRE_PREDICATE GAME_IS ~bgee bg2ee eet iwdee~ @2
		
		OUTER_SET global_index = 1		// execution index (incremented by 1 for every item)
		OUTER_SET global_index_next = 2	// execution index (incremented by 1 for every item)

		COMPILE EVALUATE_BUFFER ~klatu/baf/KL#CSORT.baf~
		
		ACTION_FOR_EACH item IN 
		// -----------------------------------------------------
		// ---------   CURSED SCROLLS
		// -----------------------------------------------------
			~scrl17~	// Cursed Scroll of Ailment
			~scrl11~	// Cursed Scroll of Clumsiness
			~scrl12~	// Cursed Scroll of Foolishness
			~scrl16~	// Cursed Scroll of Petrification
			~scrl18~	// Cursed Scroll of Stupidity
			~scrl14~	// Cursed Scroll of Summon Monster
			~scrl13~	// Cursed Scroll of Ugliness
			~scrl10~	// Cursed Scroll of Weakness
		// -----------------------------------------------------
		// ---------   PROTECTION SCROLLS
		// -----------------------------------------------------
			~scrl03~	// Protection From Acid
			~scrl04~	// Protection From Cold
			~scrl05~	// Protection From Electricity
			~scrl06~	// Protection From Fire
			~scrl07~	// Protection From Magic
			~scrl15~	// Protection From Petrification
			~scrl08~	// Protection From Poison
			~scrl09~	// Protection From Undead
			~scrlpet~	// Stone to Flesh Scroll
			~scrlpet2~	// Stone to Flesh Scroll
		// -----------------------------------------------------
		// ---------   CLERIC SCROLLS (BGI & II, IWD, Tweaks Anthology, ???)
		// -----------------------------------------------------
			~ag#ir0h~	// Aerial Servant
			~sppr201c~	// Aid
			~ag#ir03~	// Armor of Faith
			~sppr610x~	// Blade Barrier
			~ag#ir0i~	// Blade Barrier
			~ag#ir01~	// Bless
			~ag#ir0k~	// Bolt of Glory
			~ag#ir0b~	// Break Enchantment
			~scrl5e~	// Champion's Strength 
			~sppr507c~	// Champion's Strength
			~sppr203c~	// Chant
			~ag#ir04~	// Chant
			~scrl5f~	// Chaotic Commands
			~sppr314c~	// Cure Disease
			~sppr103c~	// Cure Light Wounds
			~scrl61~	// Cure Critical Wounds
			~sppr214c~	// Cure Moderate Wounds
			~scrl56~	// Cure Serious Wounds 
			~scrl5b~	// Defensive Harmony
			~ag#ir09~	// Dispel Magic
			~ag#ir08~	// Draw upon Divine Might
			~sppr105c~	// Entangle
			~sppr331x~	// Favor of Ilmater
			~sppr205c~	// Find Traps
			~ag#ir05~	// Find Traps
			~ag#ir0l~	// Fire Storm
			~scrl62~	// Flame Strike
			~scrl58~	// Free Action
			~sppr304c~	// Glyph of Warding
			~ag#ir0a~	// Glyph of Warding
			~sppr607c~	// Heal
			~ag#ir0j~	// Heal
			~sppr208c~	// Hold Person
			~sppr324x~	// Holy Smite
			~ag#ir0d~	// Holy Smite
			~sppr510c~	// Insect Plague
			~restore~	// Lesser Restoration
			~ag#ir0f~	// Magic Resistance
			~ag#ir0g~	// Mass Cure
			~scrl5a~	// Mental Domination
			~scrl59~	// Neutralize Poison
			~sppr404c~	// Neutralize Poison
			~sppr313c~	// Prayer
			~scrl3h~	// Protection From Evil
			~scrl5d~	// Protection From Evil, 10' Radius 
			~sppr306c~	// Protection From Fire
			~scrl5c~	// Protection From Lightning 
			~sppr407c~	// Protection From Lightning
			~scrl63~	// Raise Dead
			~sppr504c~	// Raise Dead
			~ag#ir0n~	// Regeneration
			~sppr108c~	// Remove Fear
			~sppr307c~	// Remove Curse
			~sppr308c~	// Remove Paralysis
			~ag#ir0c~	// Remove Paralysis
			~sppr712c~	// Resurrection
			~ag#ir02~	// Sanctuary
			~ag#ir06~	// Silence
			~sppr211c~	// Silence, 15' Radius
			~sppr212c~	// Slow Poison
			~sppr512c~	// Spike Stones
			~ag#ir0m~	// Sunray
			~sppr714c~	// Symbol, Pain
			~ag#ir07~	// True Seeing
			~ag#ir0e~	// Unholy Smite
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (BG and IWD)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~scrl67~	// Armor
			~scrl71~	// Blindness
			~scrl68~	// Burning Hands
			~scrl69~	// Charm Person
			~scrl82~	// Chill Touch
			~scrl83~	// Chromatic Orb
			~scrl70~	// Color Spray
			~spwi126x~	// Expeditious Retreat
			~scrl6d~	// Find Familiar
			~scrl72~	// Friends
			~scrl66~	// Grease
			~scrl75~	// Identify
			~scrl76~	// Infravision
			~scrl84~	// Larloch's Minor Drain
			~scrl77~	// Magic Missile
			~scrl78~	// Protection From Evil
			~scrl73~	// Protection From Petrification
			~scrl5u~	// Reflected Image
			~scrl79~	// Shield
			~scrl80~	// Shocking Grasp
			~scrl81~	// Sleep
			~scrla6~	// Spook
		// LEVEL  2 --------------------------------------------
			~scrl1b~	// Agannazars Scorcher
			~scrl85~	// Blur
			~spwi223a~	// Cat's Grace
			~cdia223~	// Cat's Grace
			~scrla2~	// Deafness
			~scdeca~	// Decastave
			~cdia221~	// Decastave
			~scrl86~	// Detect Evil
			~scrl87~	// Detect Invisibility
			~scrl1c~	// Ghoul Touch
			~scrla3~	// Glitterdust
			~scrl89~	// Horror
			~scrl90~	// Invisibility
			~scrl91~	// Knock
			~scrl92~	// Know Alignment
			~scrl93~	// Luck
			~scrl95~	// Melf's Acid Arrow
			~scrl96~	// Mirror Image
			~scrl6e~	// Power Word, Sleep
			~scrl6f~	// Ray of Enfeeblement
			~scrlai~	// Ray of Enfeeblement
			~scrl94~	// Resist Fear
			~scsnill~	// Snilloc's Snowball Swarm
			~cdia220~	// Snilloc's Snowball Swarm
			~scrl97~	// Stinking Cloud
			~scrl98~	// Strength
			~scrl3g~	// Vocalize
			~scrl99~	// Web
		// LEVEL  3 --------------------------------------------
			~scrl1d~	// Clairvoyance
			~scrl6k~	// Detect Illusion
			~scrl1s~	// Dire Charm
			~scrl1e~	// Dispel Magic
			~scrl1g~	// Fireball
			~scrl5z~	// Fireball
			~scrl1f~	// Flame Arrow
			~ttscrl01~	// Flame Arrow
			~scrl1t~	// Ghost Armor
			~scrl1h~	// Haste
			~scrl1i~	// Hold Person
			~scrl6l~	// Hold Undead
			~scice~		// Icelance
			~cdia318~	// Icelance
			~scrl1j~	// Invisibility, 10' Radius
			~spwi319x~	// Lance of Disruption
			~cdia319~	// Lance of Disruption
			~scrl1k~	// Lightning Bolt
			~scrla5~	// Melf's Minute Meteors
			~scrl6g~	// Minor Spell Deflection
			~scrl1l~	// Monster Summoning I
			~ttscrl02~	// Monster Summoning I
			~scrl1m~	// Non-Detection
			~scrl6i~	// Protection From Cold
			~scrl6h~	// Protection From Fire
			~scrl1n~	// Protection from Normal Missiles
			~scrla7~	// Remove Magic
			~scrl1p~	// Skull Trap
			~scrl1o~	// Slow
			~scrl6j~	// Spell Thrust
			~scrl1q~	// Vampiric Touch
			~scrl1r~	// Wraith Form
			~u!scrl03~	// Wraith Form
		// LEVEL  4 --------------------------------------------
			~scbloo~	// Beltyn's Burning Blood
			~cdia417~	// Beltyn's Burning Blood
			~scrl1u~	// Confusion
			~scrla8~	// Contagion
			~scrl1v~	// Dimension Door
			~bgscrl1v~	// Dimension Door
			~sccour~	// Emotion: Courage
			~cdia419~	// Emotion: Courage
			~scfear~	// Emotion: Fear
			~cdia420~	// Emotion: Fear
			~scemot~	// Emotion: Hope
			~cdia421~	// Emotion: Hope
			~scrl5h~	// Emotion: Hopelessness
			~schope~	// Emotion: Hopelessness
			~scrl6m~	// Enchanted Weapon
			~scrlaj~	// Farsight
			~scrlaq~	// Farsight
			~scrl1w~	// Fireshield (Blue)
			~scrl6n~	// Fireshield (Red)
			~scrl5i~	// Greater Malison
			~scmali~	// Greater Malison
			~scrl1x~	// Ice Storm
			~scstor~	// Ice Storm
			~scrl1y~	// Improved Invisibility
			~scrl1z~	// Minor Globe of Invulnerability
			~scrl6p~	// Minor Sequencer
			~scrl2a~	// Monster Summoning II
			~spwi422x~	// Mordenkainen's Force Missiles
			~scrl5j~	// Otiluke's Resilient Sphere
			~scotil~	// Otiluke's Resilient Sphere
			~scrl5l~	// Polymorph Other
			~scrl5m~	// Polymorph Self
			~scrl5g~	// Remove Curse
			~scrlak~	// Remove Curse
			~screm~		// Remove Curse
			~scrl6o~	// Secret Word
			~scshad~	// Shadow Monsters
			~cdia418~	// Shadow Monsters
			~spwi423x~	// Shout
			~scrl6r~	// Spider Spawn
			~scrl5k~	// Spirit Armor
			~scspir~	// Spirit Armor
			~scrl2b~	// Stoneskin
			~scston~	// Stoneskin
			~scrl6q~	// Teleport Field
			~spwi424x~	// Vitriolic Sphere
			~cdia424~	// Vitriolic Sphere
			~scrla1~	// Wizard Eye
		// LEVEL  5 --------------------------------------------
			~scrl2d~	// Animate Dead
			~scrl6u~	// Breach
			~scrl5p~	// Chaos
			~scchao~	// Chaos
			~scrl2e~	// Cloudkill
			~scrl2f~	// Cone of Cold
			~sccae~		// Conjure Air Elemental
			~scrl7b~	// Conjure Lesser Air Elemental
			~sccee~		// Conjure Earth Elemental
			~scrl7c~	// Conjure Lesser Earth Elemental
			~sccfe~		// Conjure Fire Elemental
			~scrl6x~	// Conjure Lesser Fire Elemental
			~sccwe~		// Conjure Water Elemental
			~spwi517x~	// Contact Other Plane
			~cdia517~	// Contact Other Plane
			~scdms~		// Demi-Shadow Monsters
			~cdia512~	// Demi-Shadow Monsters
			~scrl5n~	// Domination
			~scdomi~	// Domination
			~scrl5q~	// Feeblemind
			~scfeeb~	// Feeblemind
			~scrl5o~	// Hold Monster
			~schmon~	// Hold Monster
			~scrl6v~	// Lower Resistance
			~spwi518x~	// Lower Resistance
			~scrl7d~	// Minor Spell Turning
			~scrl2g~	// Monster Summoning III
			~scrl6w~	// Oracle
			~scrl6z~	// Phantom Blade
			~scrl6y~	// Protection From Acid
			~scrl5t~	// Protection From Electricity
			~scrl6t~	// Protection from Normal Weapons
			~scrl2h~	// Shadow Door
			~scshro~	// Shroud of Flame
			~cdia511~	// Shroud of Flame
			~scrl6s~	// Spell Immunity
			~scrl8x~	// Spell Shield
			~u!scrl02~	// Summon Cow
			~scssha~	// Summon Shadow
			~cdia513~	// Summon Shadow
			~scrlal~	// Sunfire
			~scrlar~	// Sunfire
			~spwi519x~	// Sunfire
		// LEVEL  6 --------------------------------------------
			~scams~		// Antimagic Shell
			~cdia601~	// Antimagic Shell
			~scrl8a~	// Carrion Summons
			~scrl7s~	// Chain Lightning
			~scclite~	// Chain Lightning
			~scrl7y~	// Conjure Air Elemental
			~scrl7z~	// Conjure Earth Elemental
			~scrl7x~	// Conjure Fire Elemental
			~scrl7u~	// Contingency
			~spwi618x~	// Darts of Bone
			~cdia618~	// Darts of Bone
			~scrl7r~	// Death Fog
			~scdfog~	// Death Fog
			~scrl7i~	// Death Spell
			~scdspel~	// Death Spell
			~scrl7t~	// Disintegrate
			~scdisi~	// Disintegrate
			~scrl7h~	// Flesh to Stone
			~scfts~		// Flesh to Stone
			~scrl7f~	// Globe of Invulnerability
			~scglob~	// Globe of Invulnerability
			~scrl7q~	// Improved Haste
			~scrl7e~	// Invisible Stalker
			~scistal~	// Invisible Stalker
			~sclich~	// Lich Touch
			~cdia610~	// Lich Touch
			~scrl7k~	// Mislead
			~scmsiv~	// Monster Summoning IV
			~cdia611~	// Monster Summoning IV
			~scofs~		// Otiluke's Freezing Sphere
			~cdia612~	// Otiluke's Freezing Sphere
			~scrl7l~	// Pierce Magic
			~scrl7p~	// Power Word, Silence
			~scpws~		// Power Word, Silence
			~scrl7j~	// Protection From Magic Energy
			~scrl7o~	// Protection from Magical Weapons
			~scshds~	// Shades
			~cdia613~	// Shades
			~spwi619x~	// Soul Eater
			~scrl7v~	// Spell Deflection
			~scrl8c~	// Stone to Flesh
			~scstf~		// Stone to Flesh
			~scrl8b~	// Summon Nishruu
			~scrl7g~	// Tenser's Transformation
			~sctens~	// Tenser's Transformation
			~spwi620x~	// Trollish Fortitude
			~cdia620~	// Trollish Fortitude
			~scrl7m~	// True Sight
			~scrl7w~	// Wyvern Call
		// LEVEL  7 --------------------------------------------
			~scacid~	// Acid Storm
			~cdia708~	// Acid Storm
			~scrl8i~	// Cacofiend
			~scrl8v~	// Control Undead
			~scrl8n~	// Delayed Blast Fireball
			~scrl8o~	// Finger of Death
			~scfing~	// Finger of Death
			~scrla4~	// Limited Wish
			~scmala~	// Malavon's Rage
			~cdia707~	// Malavon's Rage
			~scrl8j~	// Mantle
			~scrl8w~	// Mass Invisibility
			~scminvi~	// Mass Invisibility
			~scmsv~		// Monster Summoning V
			~cdia703~	// Monster Summoning V
			~scrl8r~	// Mordenkainen's Sword
			~scmord~	// Mordenkainen's Sword
			~scrl8q~	// Power Word, Stun
			~scstun~	// Power Word, Stun
			~scrl8p~	// Prismatic Spray
			~scprism~	// Prismatic Spray
			~scrl8f~	// Project Image
			~scrl8e~	// Protection from the Elements
			~scrl8g~	// Ruby Ray of Reversal
			~spwi710x~	// Seven Eyes
			~scrl8l~	// Spell Sequencer
			~scrl8d~	// Spell Turning
			~scrl8m~	// Sphere of Chaos
			~spwi711x~	// Suffocate
			~cdia711~	// Suffocate
			~scrl8t~	// Summon Djinni
			~scrl8s~	// Summon Efreeti
			~scrl8u~	// Summon Hakeashar
			~scrl8h~	// Khelben's Warding Whip
		// LEVEL  8 --------------------------------------------
			~scrl9g~	// Abi-Dalzim's Horrid Wilting
			~spwi805x~	// Abi-Dalzim's Horrid Wilting
			~scrlb1~	// Bigby's Clenched Fist
			~spwi806x~	// Great Shout
			~scrl9c~	// Improved Mantle
			~scrl9e~	// Incendiary Cloud
			~scincin~	// Incendiary Cloud
			~spwi807x~	// Iron Body
			~cdia807~	// Iron Body
			~scrl9h~	// Maze
			~scblank~	// Mind Blank
			~cdia804~	// Mind Blank
			~scmsvi~	// Monster Summoning VI
			~cdia803~	// Monster Summoning VI
			~scrl9a~	// Pierce Shield
			~scrl9j~	// Power Word, Blind
			~spwi808x~	// Power Word, Blind
			~scrl8y~	// Protection from Energy
			~scrl8z~	// Simulacrum
			~scrl9d~	// Spell Trigger
			~scrl9b~	// Summon Fiend
			~scrlam~	// Symbol, Death
			~scrlao~	// Symbol, Death
			~scrl9f~	// Symbol, Fear
			~scrlan~	// Symbol, Stun
			~scrlap~	// Symbol, Stun
		// LEVEL  9 --------------------------------------------
			~scrl9p~	// Absolute Immunity
			~scrlb2~	// Bigby's Crushing Hand
			~scrl9x~	// Black Blade of Disaster
			~scrl9q~	// Chain Contingency
			~scrl9w~	// Energy Drain
			~scrl9z~	// Freedom
			~scrl9n~	// Gate
			~scrl9s~	// Imprisonment
			~scrl9t~	// Meteor Swarm
			~scmsvii~	// Monster Summoning VII
			~cdia902~	// Monster Summoning VII
			~scrl9u~	// Power Word, Kill
			~sckill~	// Power Word, Kill
			~scrl9y~	// Shapechange
			~scrl9m~	// Spellstrike
			~scrl9l~	// Spell Trap
			~scrl9r~	// Time Stop
			~scrl9v~	// Wail of the Banshee
			~scrlb4~	// Wish
		// -----------------------------------------------------
		// ---------   CLERIC SCROLLS (MOD: DSotSC)
		// -----------------------------------------------------
		// LEVEL  7 --------------------------------------------
			~scrlds75~	// Selune's Curse
			~scrlds76~	// Summon Sirine
			~scrlds77~	// Thunder Bolt
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: DSotSC & NT)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~scrlds11~	// Orb of Air
		// LEVEL  2 --------------------------------------------
			~scrlds22~	// Icebolt
			~scrlds23~	// Minor Globe of Darkness
			~scrlds21~	// Thunderslap
		// LEVEL  3 --------------------------------------------
			~scrlds32~	// Army of One
			~scrlds31~	// Ray of Frost
			~scrlds34~	// Wraith Form
		// LEVEL  4 --------------------------------------------
			~scrlds42~	// Ajandurah's Ice Shard
			~scrlds41~	// Ettin's Healing
		// LEVEL  5 --------------------------------------------
			~scrlds51~	// Melf's Explosive Meteors
		// LEVEL  6 --------------------------------------------
			~scrlds62~	// Anti-Magic Shell
			~scrlds61~	// Geas
		// LEVEL  7 --------------------------------------------
			~scrlds73~	// Fire Storm
			~scrlds72~	// Mass Charm
			~scrlnt71~	// Skeleton Guard
			~scrlds71~	// Sphere of Energy Dissipation
			~scrlds74~	// Vestcakes Floating Curse
		// LEVEL  8 --------------------------------------------
			~scrlnt81~	// Fiery Cloud
			~scrlds81~	// Infernal Combustion Enigma
			~scrlds82~	// Insanity
			~scrlds83~	// Miasma
			~scrlds84~	// Thunder Bolt
			~scrlds85~	// Varashar's Life Drain
		// LEVEL  9 --------------------------------------------
			~scrlds91~	// Arc of Death
			~scrlds92~	// Azuth's Rune of Utter Negativity
			~scrlds93~	// Heal
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: CtB
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~cbwt7a10~	// Eagle's Splendor
		// LEVEL  2 --------------------------------------------
			~cbwt7e10~	// Cat's Grace
			~cbwt7b10~	// Decastave
		// LEVEL  3 --------------------------------------------
			~cbspkded~	// Speak With Dead
		// LEVEL  4 --------------------------------------------
			~cbwt7d10~	// Mordenkainen's Force Missiles
		// LEVEL  5 --------------------------------------------
			~cbwt7f10~	// Ball Lightning
			~cbwt7g10~	// Lutzaen's Frequent Jaunt
		// LEVEL  6 --------------------------------------------
			~cbwt7h10~	// Anti-Magic Shell
			~cbwt7c10~	// Darts of Bone
			~cbwt7i10~	// Lich Touch
			~cbwt7j10~	// Trollish Fortitude
		// LEVEL  8 --------------------------------------------
			~cbwt7k10~	// Mind Blank
			~cbwt7l10~	// Iron Body
			~cbmalr5a~	// Whirlwind of Steel
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: Planar Sphere Mod)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
		// LEVEL  2 --------------------------------------------
			~psqaura~	// Aura of Power
			~psqtysp~	// Tyndal's Spacial Compressor
			~psspl16~	// Shadrick's Shattering Arrow
		// LEVEL  3 --------------------------------------------
		// LEVEL  4 --------------------------------------------
			~psspl05~	// Ajundurar's Ice Shard
			~psspl17~	// Black-Barbed Curse
			~psqkkks~	// Kelton's Kinetic Knives
		// LEVEL  5 --------------------------------------------
			~psqirid~	// Iridium Sphere
			~psspl13~	// Vest cakes Floating Curse
			~psqvorp~	// Vorpal Bolt
		// LEVEL  6 --------------------------------------------
			~psqbrbo~	// Berrilium's Brilliant Bouquet
			~psshldde~	// Poison Shield
			~psqshh~	// Summon Helmed Horror
			~psspl18~	// Unthinkable Logic
		// LEVEL  7 --------------------------------------------
			~psspl01~	// Infernal Combustion Enigma
			~psqkilpo~	// Killimer's Power Nullification
			~psspl06~	// Melt
			~psspl09~	// Storm Force
			~psspl12~	// Tectonic Titillation
			~psqtfir~	// Triple Fireball Blast
			~psqttc~	// Tyndal's Temporal Compressor
		// LEVEL  8 --------------------------------------------
			~psqevis~	// Evisceration
			~psqnima~	// Nightmare Syndrome
			~psspl11~	// Power Word: Vaporise
			~psspl07~	// Recemon's Wonderful Rejuvenation
			~psqslcg~	// Soul Cage
			~psspl15~	// Sphere of Dissipation
			~psspl02~	// Thunderbolt
		// LEVEL  9 --------------------------------------------
			~psspl04~	// Abyssal Fury
			~psspl08~	// Azuth's Rune of Utter Negativity
			~psqsmin~	// Create Minion
			~psqkcf~	// Karsus' Crimson Flames
			~psqpyro~	// Nagaths Polarized Pyrotechnics
			~psspl03~	// Power Word: Burn
			~psqrequ~	// Requiem of Elysium
			~psspl14~	// Wave of Obliteration
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: VECNA)
		// -----------------------------------------------------
		// LEVEL  4 --------------------------------------------
			~aadoor~	// Dimension Door
		// LEVEL  6 --------------------------------------------
			~aaitm187~	// Otiluke's Force Helm
		// LEVEL  7 --------------------------------------------
			~aaitm181~	// Golden Cloud
		// LEVEL  8 --------------------------------------------
			~aaitm180~	// Hero
			~aaitm157~	// Whirlwind of Steel
		// LEVEL  9 --------------------------------------------
			~aaitm186~	// Animate Golem
			~aaitm179~	// Azuth's Rune of Utter Negativity
			~aaitm185~	// Instant Army
			~aaitm169~	// Karsus' Crimson Flames
			~aaitm158~	// Life Warping
			~aaitm159~	// Molecular Disjointment
			~aaplshft~	// Plane Shift
			~aaitm184~	// Prismatic Sphere
			~aaitm182~	// Soul Rot
			~aaitm183~	// Wall of Force
		// LEVEL 10 --------------------------------------------
			~aavecna6~	// Vecnas elemental fury
			~aavecna1~	// Vecnas Evisiration
			~aavecna5~	// Vecnas explosive implosion (what.)
			~aavecna3~	// Vecnas Personal Fire Ball
			~aavecna4~	// Vecnas Phoenix Summons
			~aavecna2~	// Vecnas Star Portal
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ???)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~dgscrb1~	// Amber Red
			~dgscr01~	// Red Spike
		// LEVEL  2 --------------------------------------------
			~dgscr02~	// Violet's Fruit
		// LEVEL  3 --------------------------------------------
			~dgscr03~	// Crushing Blue
		// LEVEL  4 --------------------------------------------
			~dgscr04~	// Silver Life
		// LEVEL  5 --------------------------------------------
			~dgscr05~	// Red Rain
		// LEVEL  6 --------------------------------------------
			~dgscr06~	// Golden Power
		// LEVEL  7 --------------------------------------------
			~dgscr07~	// Amber Rose
		// LEVEL  8 --------------------------------------------
			~dgscr08~	// Black Death
		// LEVEL  9 --------------------------------------------
			~dgscr09~	// Crying Palette of Colours
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ??? shadow magic/weave something)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~l#fsps1~	// Shadow Command
		// LEVEL  2 --------------------------------------------
			~l#fsps2~	// Shadow Summoning I
		// LEVEL  3 --------------------------------------------
			~l#fsps3~	// Holding Shadow
		// LEVEL  4 --------------------------------------------
			~l#fsps4~	// Shadow thievery
		// LEVEL  5 --------------------------------------------
			~l#fsps5~	// Outerblack
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ???)
		// -----------------------------------------------------
		// LEVEL  8 --------------------------------------------
			~scrlb04~	// Enormous Self-Polymorph
		// LEVEL  9 --------------------------------------------
			~scrlb05~	// Angelic Bow
			~scrlb01~	// Magnetic Impulse
			~scrlb03~	// Summon Giant
			~scrlb02~	// Weeping Ghost
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: TDD???)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~scrx2~ 	// Physical Agility
			~scrx3~ 	// True Strike
		// LEVEL  2 --------------------------------------------
			~scrx1~ 	// Azragan's Chanelling
			~scrx6~ 	// Cat's Grace
			~scrx5~ 	// Steam
			~scrx4~ 	// Torment
		// LEVEL  3 --------------------------------------------
			~scrx10~ 	// Adrenalin Rush
			~scrx8~ 	// Aura of Focus
			~scrx9~ 	// Ice Lance
			~scrx68~ 	// Inaccuracy
		// LEVEL  4 --------------------------------------------
			~scrx11~ 	// Daer'Ragh's Aura Cleansing
			~scrx71~ 	// Emotion: Courage
			~scrx72~ 	// Emotion: Fear
			~scrx73~ 	// Emotion: Hope
			~scrx12~ 	// Ice Shard
			~scrx64~ 	// Mordenkainen's Force Missiles
			~scrx60~ 	// Mordenkainen's Phantom Shield Maidens
			~scrx65~ 	// Otiluke's Diamond Screen
			~scrx13~ 	// Weaken
		// LEVEL  5 --------------------------------------------
			~scrx14~ 	// Heavy Fog
			~scrx74~ 	// Melf's Prismatic Shards
		// LEVEL  6 --------------------------------------------
			~scrx69~ 	// Animate Dread Warrior
			~scrx16~ 	// Anti-Magic Shell
			~scrx59~ 	// Black Mantle
			~scrx15~ 	// Mass Teleport
			~scrx63~ 	// Transmute Steel To Bone
		// LEVEL  7 --------------------------------------------
			~scrx22~ 	// Armor Melt
			~scrx18~ 	// Assimilation
			~scrx19~ 	// Black Death
			~scrx52~ 	// Drowned Dead
			~scrx7~ 	// Endurance
			~scrx23~ 	// Execution
			~scrx21~ 	// Frost Bite
			~scrx17~ 	// Monster Summoning IV
			~scrx20~ 	// Raging Bull
			~scrx70~ 	// Wall of White Magic
		// LEVEL  8 --------------------------------------------
			~scrx51~ 	// Eyes Of Wrath
			~scrx56~ 	// Globe Of Darkness
			~scrx33~ 	// Gravity
			~scrx26~ 	// Hemophilia
			~scrx29~ 	// Iron Body
			~scrx54~ 	// Mass Charm
			~scrx48~ 	// Mind Rot
			~scrx24~ 	// Monster Summoning V
			~scrx55~ 	// Mystic Barrier
			~scrx25~ 	// Orcish Horde
			~scrx76~ 	// Otiluke's Acid Cloud
			~scrx77~ 	// Otiluke's Death Screen
			~scrx28~ 	// Rary's Mnemonic Negator
			~scrx27~ 	// Soul of Kalan-Zhar
			~scrx32~ 	// Suffocation
			~scrx31~ 	// Sun Burst
		// LEVEL  9 --------------------------------------------
			~scrx88~ 	// Algarth's Embattlement
			~scrx62~ 	// Animate Golem
			~scrx43~ 	// Anti-Magic Cloud
			~scrx40~ 	// Arcane Runes
			~scrx89~ 	// Arcane Surge
			~scrx35~ 	// Army Of Darkness
			~scrx58~ 	// Create Minion
			~scrx47~ 	// Daelomin's Drastic Dromedary
			~scrx61~ 	// Genocide
			~scrx57~ 	// Instant Army
			~scrx66~ 	// Khelben's Blackstaff
			~scrx81~ 	// Khelben's Dweomerdoom
			~scrx37~ 	// Life Warping
			~scrx46~ 	// Malygnus' Shattering Obelisk
			~scrx49~ 	// Molecular Disjointment
			~scrx34~ 	// Monster Summoning VI
			~scrx53~ 	// Prismatic Sphere
			~scrx41~ 	// Rary's Mnemonic Enhancer
			~scrx39~ 	// Sacrificial Transfer
			~scrx38~ 	// Shatter Bones
			~scrx50~ 	// Soul Rot
			~scrx36~ 	// Tattoo
			~scrx42~ 	// Weird
			~scrx67~ 	// Vampiric Mist
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ???)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~SOAITM50~	// Heralds Call
			~SOAITM51~	// Ice Dagger
			~SOAITM56~	// Nybor's Gentle Reminder
		// LEVEL  2 --------------------------------------------
			~SOAITM58~	// Skeleton Armor
		// LEVEL  3 --------------------------------------------
			~SOAITM52~	// Magic Shield
			~SOAITM54~	// Nybor's Mild Admonishment
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ???)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
		// LEVEL  2 --------------------------------------------
		// LEVEL  3 --------------------------------------------
			~SPPSOIF~	// Otiluke's Intangible Filter
		// LEVEL  4 --------------------------------------------
		// LEVEL  5 --------------------------------------------
		// LEVEL  6 --------------------------------------------
			~SPPSBTA~	// Blood to Acid
		// LEVEL  7 --------------------------------------------
			~SPPSOBB~	// Otiluke's Bouncy Bubbles
		// LEVEL  8 --------------------------------------------
			~SPPSMSR~	// Melectar's Spell Regeneration
			~SPPSMOH~	// Mordenkainen's Forceful Hammer
			~SPPSTPA~	// Tereledra's Pocket Army
		// LEVEL  9 --------------------------------------------
			~SPPSDMA~	// Dance Macabre
		// -----------------------------------------------------
		// ---------	WIZARD SPELL SCROLLS (MOD: ???)
		// -----------------------------------------------------
		// LEVEL  1 --------------------------------------------
			~eagles~	// Eagle's Splendor
			~tacstaf~ 	// Sapient Staff
			~ddscr229~	// Thunderclap (spwi229)
			~posc229a~	// Thunderclap (spwi229)
		// LEVEL  2 --------------------------------------------
			~scrlzy~	// Summon Cow (spwi299)
			~scrlzz~	// Summon Cow (spwi299)
		// LEVEL  3 --------------------------------------------
			~sd_ocdm~	// Otiluke's Cloak of Dispel Magic
		// LEVEL  4 --------------------------------------------
			~s!scrl01~	// Ray of Fragmentation
			~spwi4so~	// Siegfrieds Scorching Supplication
		// LEVEL  5 --------------------------------------------
			~iceexpl~	// Ice Exploder
			~iiradt~	// Improved Invisibility 10' radius
		// LEVEL  6 --------------------------------------------
			~candleb1~	// Blood of the Martyr
			~wakeinf~ 	// Wake of the Inferno
		// LEVEL  7 --------------------------------------------
			~mmchal~	// Conversion
			~z_scl1~ 	// Divine Fireball
			~goldencl~	// Golden Cloud
			~servidor~	// Guarded Dimensional Chest
			~burgas~	// Poisonous Gas
			~rztelep~	// Teleport
		// LEVEL  8 --------------------------------------------
			~zzscrl01~	// Eyes Of Wrath
			~scrlw801~	// Ghostform
		// LEVEL  9 --------------------------------------------
			~apoc~ 		// Apocalypse
			~zzscrl02~	// Bigby's Crushing Hand
			~regfield~ 	// Regeneration Field
			~dragnsum~ 	// Summon Blue Dragon
			~sumdrag~ 	// Summon Dragon
			~sd_sif~	// Summon the Infernal Host
			~ultima~ 	// Ultima
			~scrm104~ 	// Wall of Force
			~zzscrl03~	// Wall of Force
		BEGIN
			ACTION_IF FILE_EXISTS_IN_GAME ~%item%.itm~ BEGIN
				OUTER_SPRINT outer_item ~%item%~
				EXTEND_BOTTOM ~KL#CSORT.bcs~ ~klatu/baf/KL#CSORT_STACKABLE.baf~ EVALUATE_BUFFER
				OUTER_SET global_index = global_index + 1
				OUTER_SET global_index_next = global_index_next + 1
			END
		END
		EXTEND_BOTTOM ~KL#CSORT.bcs~ ~klatu/baf/KL#CSORT_END.baf~ EVALUATE_BUFFER
		
		COPY ~klatu/cre/KL#CSORT.cre~ ~override~
		COMPILE EVALUATE_BUFFER ~klatu/baf/KLA#SORT.baf~
		
		ACTION_FOR_EACH familiar IN 
		~famil1~
		~famil125~
		~famil2~
		~famil225~
		~famil3~
		~famil325~
		BEGIN
			ACTION_IF FILE_EXISTS_IN_GAME ~%familiar%.dlg~ BEGIN
				OUTER_SPRINT outer_dialog ~%familiar%~
				COMPILE EVALUATE_BUFFER ~klatu/d/famil.d~
			END
		END

/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////
/////                                                       /////
///// Cosmetic Changes                                      /////
/////                                                       /////
/////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute Kelsey's Romance Music                           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @69 DESIGNATED 3000
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~KELSEY.TP2~ ~0~ @198 // Required mod component missing
		
		COPY	~klatu/wav/mute.wav~ ~override/fwksong.wav~

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute Xan's Romance Music                              /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @71 DESIGNATED 3010
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~XAN/SETUP-XAN.TP2~ ~0~ @198 // Required mod component missing
		
		COPY	~klatu/wav/mute.wav~ ~override/O#Xan.wav~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute Adrian's Romance Music                           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @140 DESIGNATED 3020
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~ADRIAN/SETUP-ADRIAN.TP2~ ~0~ @198 // Required mod component missing
		
		COPY	~klatu/wav/mute.wav~ ~override/rh#adrom.wav~
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute Isra's Romance Music                             /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @137 DESIGNATED 3030
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~ISRA_BG2/ISRA_BG2.TP2~ ~0~ @198 // Required mod component missing
		
		COPY	~klatu/wav/mute.wav~ ~override/rh#isong.wav~
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute Kivan's BG2 music tracks                         /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @192 DESIGNATED 3040
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~KIVAN/SETUP-KIVAN.TP2~ ~0~ @198 // Required mod component missing
		
		ACTION_FOR_EACH song IN ~kivan00~ ~kivan000~ ~p#deh00~ BEGIN
			COPY	~klatu/wav/mute.wav~ ~override/%song%.wav~
		END
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Mute BG1 NPC Project music tracks                     /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @193 DESIGNATED 3050
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~BG1NPC/BG1NPC.TP2~ ~0~ @198 // Required mod component missing
		
		ACTION_FOR_EACH song IN 
			~ajant99~ ~alora99~ ~branw99~ ~coran99~
			~dynah99~ ~edwin99~ ~eldot99~ ~faldo99~
			~garri99~ ~imoen99~ ~jahei99~ ~kagain99~
			~khali99~ ~kivan99~ ~minsc99~ ~monta99~
			~quayl99~ ~safana99~ ~shart99~ ~skie99~
			~tiax99~ ~vicon99~ ~xannn99~ ~xzar99~
			~yesli99~ ~ajrom~ ~brar1~ ~brar2~
			~brrom~ ~coranb~ ~coranf~ ~corang~
			~corann~ ~dyrom1~ ~dyrom2~ ~shrar~
			~xanro1~ ~xarom~
		BEGIN
			COPY	~klatu/wav/mute.wav~ ~override/%song%.wav~
		END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// CtB: Mute the Cowled Wizard                           /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @199 DESIGNATED 3060
		GROUP @70 // Cosmetic Changes
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE MOD_IS_INSTALLED ~CTB/SETUP-CTB.TP2~ ~0~ @198 // Required mod component missing
		
		ACTION_FOR_EACH file IN 
			~349~ ~350~ ~351~ ~352~ ~353~ ~354~ ~355~ ~356~
			~358~ ~359~ ~360~ ~361~ ~362~ ~363~ ~364~ ~365~
			~369~ ~371~ ~372~ ~373~ ~374~ ~375~ ~377~ ~378~
			~379~ ~383~ ~384~ ~385~ ~386~ ~387~ ~388~ ~390~
			~392~ ~394~ ~395~ ~396~ ~397~ ~398~ ~399~ ~400~
			~401~ ~402~ ~403~ ~404~ ~406~ ~407~ ~410~ ~411~
			~412~ ~413~ ~414~ ~415~ ~418~ ~419~ ~420~ ~421~
			~422~ ~423~ ~424~ ~425~ ~426~ ~427~ ~428~ ~488~
			~492~ ~496~ ~500~ ~501~ ~503~ ~505~ ~507~ ~508~
			~509~ ~510~ ~515~ ~516~ ~517~ ~518~ ~519~ ~520~
			~521~ ~522~ ~525~ ~526~ ~527~ ~528~ ~532~ ~533~
			~534~ ~535~ ~536~ ~537~ ~538~ ~540~ ~543~ ~546~
			~547~ ~548~ ~549~ ~551~ ~552~ ~553~ ~554~ ~556~
			~557~ ~558~ ~559~ ~560~ ~561~ ~562~ ~563~ ~564~
			~565~ ~566~ ~570~ ~571~ ~572~ ~573~ ~574~ ~575~
			~576~ ~580~ ~584~ ~588~ ~589~ ~591~ ~593~ ~595~
			~596~ ~597~ ~598~ ~599~ ~600~ ~601~ ~602~ ~603~
			~604~ ~605~ ~606~ ~607~ ~608~ ~610~ ~611~ ~612~
			~613~ ~614~ ~615~ ~616~ ~618~ ~619~ ~620~ ~621~
			~622~ ~623~
		BEGIN
			COPY	~klatu/wav/mute.wav~ ~override/CBCWL%file%.wav~
		END
	
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Remove Chaos Shield icons from all items              /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @72 DESIGNATED 3070
		GROUP @70
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		INCLUDE ~klatu/lib/common.tpa~
		
		COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				READ_LONG 0x6a fxOff
				READ_SHORT 0x70 fxNum
				FOR (i = fxNum - 1; i >= 0; i = i - 1) BEGIN
					off = fxOff + i * 0x30
					READ_SHORT (off + 0x00) opcode
					READ_LONG (off + 0x08) param2
					PATCH_IF (opcode = 142 AND (param2 = 162 OR param2 = 163)) BEGIN
						LPF REMOVE_EFFECT_ITM INT_VAR idx = i END
					END
				END
			END
		BUT_ONLY

	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Change Appearance of Robe of Good Archmagi            /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @73 DESIGNATED 3080
		GROUP @70
		SUBCOMPONENT @74
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~clck15.itm~ @3
		INCLUDE ~klatu/lib/common.tpa~
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2W~ #2
			END
		BUT_ONLY
		
		BEGIN @75 DESIGNATED 3081
		GROUP @70
		SUBCOMPONENT @74
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3W~ #2
			END
		BUT_ONLY

		BEGIN @76 DESIGNATED 3082
		GROUP @70
		SUBCOMPONENT @74
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4W~ #2
			END
		BUT_ONLY

		BEGIN @77 DESIGNATED 3083
		GROUP @70
		SUBCOMPONENT @74
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2A~ #2
			END
		BUT_ONLY

		BEGIN @78 DESIGNATED 3084
		GROUP @70
		SUBCOMPONENT @74
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3A~ #2
			END
		BUT_ONLY

		BEGIN @79 DESIGNATED 3085
		GROUP @70
		SUBCOMPONENT @74
		COPY_EXISTING ~clck15.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4A~ #2
			END
		BUT_ONLY
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Change Appearance of Robe of Neutral Archmagi         /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @80 DESIGNATED 3090
		GROUP @70
		SUBCOMPONENT @81
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~clck16.itm~ @3
		INCLUDE ~klatu/lib/common.tpa~
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2W~ #2
			END
		BUT_ONLY
		
		BEGIN @82 DESIGNATED 3091
		GROUP @70
		SUBCOMPONENT @81
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3W~ #2
			END
		BUT_ONLY

		BEGIN @83 DESIGNATED 3092
		GROUP @70
		SUBCOMPONENT @81
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4W~ #2
			END
		BUT_ONLY

		BEGIN @84 DESIGNATED 3093
		GROUP @70
		SUBCOMPONENT @81
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2A~ #2
			END
		BUT_ONLY

		BEGIN @85 DESIGNATED 3094
		GROUP @70
		SUBCOMPONENT @81
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3A~ #2
			END
		BUT_ONLY

		BEGIN @86 DESIGNATED 3095
		GROUP @70
		SUBCOMPONENT @81
		COPY_EXISTING ~clck16.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4A~ #2
			END
		BUT_ONLY
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Change Appearance of Robe of Evil Archmagi            /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @87 DESIGNATED 3100
		GROUP @70
		SUBCOMPONENT @88
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~clck17.itm~ @3
		INCLUDE ~klatu/lib/common.tpa~
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2W~ #2
			END
		BUT_ONLY
		
		BEGIN @89 DESIGNATED 3101
		GROUP @70
		SUBCOMPONENT @88
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3W~ #2
			END
		BUT_ONLY

		BEGIN @90 DESIGNATED 3102
		GROUP @70
		SUBCOMPONENT @88
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4W~ #2
			END
		BUT_ONLY

		BEGIN @91 DESIGNATED 3103
		GROUP @70
		SUBCOMPONENT @88
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2A~ #2
			END
		BUT_ONLY

		BEGIN @92 DESIGNATED 3104
		GROUP @70
		SUBCOMPONENT @88
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3A~ #2
			END
		BUT_ONLY

		BEGIN @93 DESIGNATED 3105
		GROUP @70
		SUBCOMPONENT @88
		COPY_EXISTING ~clck17.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4A~ #2
			END
		BUT_ONLY
		
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	/////                                                       /////
	///// Change Appearance of Robe of Vecna                    /////
	/////                                                       /////
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
		BEGIN @94 DESIGNATED 3110
		GROUP @70
		SUBCOMPONENT @95
		REQUIRE_PREDICATE GAME_IS ~soa tob tutu tutu_totsc bgt iwd_in_bg2 bgee bg2ee eet iwdee~ @2
		REQUIRE_PREDICATE FILE_EXISTS_IN_GAME ~wa2robe.itm~ @3
		INCLUDE ~klatu/lib/common.tpa~
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2W~ #2
			END
		BUT_ONLY
		
		BEGIN @96 DESIGNATED 3111
		GROUP @70
		SUBCOMPONENT @95
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3W~ #2
			END
		BUT_ONLY

		BEGIN @97 DESIGNATED 3112
		GROUP @70
		SUBCOMPONENT @95
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4W~ #2
			END
		BUT_ONLY

		BEGIN @98 DESIGNATED 3113
		GROUP @70
		SUBCOMPONENT @95
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~2A~ #2
			END
		BUT_ONLY

		BEGIN @99 DESIGNATED 3114
		GROUP @70
		SUBCOMPONENT @95
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~3A~ #2
			END
		BUT_ONLY

		BEGIN @100 DESIGNATED 3115
		GROUP @70
		SUBCOMPONENT @95
		COPY_EXISTING ~wa2robe.itm~ ~override~
			LPF SANITIZE_ITM RET ok = ok END
			PATCH_IF ok BEGIN
				WRITE_ASCII 0x22 ~4A~ #2
			END
		BUT_ONLY
		
